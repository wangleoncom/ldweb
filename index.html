<!DOCTYPE html>
<html lang="zh-TW" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¹¿ğŸ¦Œçš„QAç¶²ç«™</title>
    <link rel="icon" href="./images/basic/icon.png" type="image/png">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#fdf2f8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./images/basic/icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Rounded+Mplus+1c:wght@400;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="./deer_db.js"></script>
    <script src="./quiz_db.js"></script> 
    <script src="./app.js"></script> 
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        (function() { var nullFunc = function() {}; })(); 
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Rounded Mplus 1c"', '"Noto Sans TC"', '"Inter"', '-apple-system', 'sans-serif'] },
                    animation: { 
                        'pop-in': 'popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards', 
                        'float': 'float 6s ease-in-out infinite',
                        'breathe': 'breathe 8s ease-in-out infinite',
                        'blob': 'blob 10s infinite',
                        'tilt': 'tilt 10s infinite linear'
                    },
                    keyframes: {
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' }, '100%': { opacity: '1', transform: 'scale(1) translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        breathe: { '0%, 100%': { opacity: '0.4' }, '50%': { opacity: '0.7' } },
                        blob: { "0%": { transform: "translate(0px, 0px) scale(1)" }, "33%": { transform: "translate(30px, -50px) scale(1.1)" }, "66%": { transform: "translate(-20px, 20px) scale(0.9)" }, "100%": { transform: "translate(0px, 0px) scale(1)" } },
                        tilt: { "0%, 50%, 100%": { transform: "rotate(0deg)" }, "25%": { transform: "rotate(1deg)" }, "75%": { transform: "rotate(-1deg)" } }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --theme-color: #ec4899; --theme-light: #fce7f3; }
        .text-theme { color: var(--theme-color); }
        .bg-theme { background-color: var(--theme-color); }
        .bg-theme-light { background-color: var(--theme-light); }
        .border-theme { border-color: var(--theme-color); }
        
        html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        body { background-color: #fdf2f8; transition: background-color 0.5s; }
        .dark body { background-color: #0f172a; }
        
        .glass-premium { 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(24px) saturate(180%); 
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass-premium { 
            background: rgba(30, 30, 30, 0.65); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        }

        .ios-btn { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
        .ios-btn:active { transform: scale(0.94); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        .spotlight-target {
            position: relative;
            z-index: 9999 !important;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85);
            pointer-events: auto;
            transition: all 0.5s ease;
        }
        
        .animated-bg {
            background: linear-gradient(120deg, var(--theme-light) 0%, #fdf2f8 50%, var(--theme-light) 100%);
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
        }
        .dark .animated-bg {
            background: linear-gradient(120deg, #1e1b4b 0%, #0f172a 50%, #312e81 100%);
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-gray-800 transition-colors duration-300 dark:text-gray-100 font-sans min-h-screen overflow-x-hidden selection:bg-pink-200 selection:text-pink-900 animated-bg pb-32"
      x-data="deerApp()" x-init="initApp()" @scroll.window="handleScroll" 
      :class="{'tutorial-active': showTutorial}"
      :style="`--theme-color: ${currentTheme.color}; --theme-light: ${currentTheme.light}`">

    <div id="idCardTemplate" style="display: none;" class="fixed top-0 left-0 w-[375px] h-[600px] flex-col justify-between rounded-[24px] overflow-hidden font-sans text-white">
        <img :src="selectedBg" class="absolute inset-0 w-full h-full object-cover z-0" crossorigin="anonymous">
        <div class="absolute inset-0 z-10 bg-gradient-to-b from-black/60 via-transparent to-black/80"></div>
        <div class="relative z-20 p-8 pt-10 flex justify-between items-start">
            <img src="./images/basic/icon.png" class="w-16 h-16 rounded-full border-2 border-white/80 shadow-md">
            <div class="text-right"><div class="text-[10px] font-bold tracking-[0.2em] opacity-80 mb-1">OFFICIAL FAN</div><div class="font-bold text-xl tracking-widest text-white drop-shadow-md">éº‹é¹¿èªè­‰</div></div>
        </div>
        <div class="relative z-20 p-8 pb-12">
            <div class="mb-6"><div class="text-[10px] font-bold tracking-[0.2em] opacity-70 mb-1">å§“å</div><div class="text-4xl font-black tracking-tight" x-text="idCardName"></div></div>
            <div class="flex justify-between items-end border-t border-white/30 pt-4"><div><div class="text-[10px] font-bold tracking-[0.2em] opacity-70 mb-1">ID NUMBER</div><div class="text-xl font-mono font-bold" x-text="generatedIdNumber"></div></div><div class="text-right"><div class="text-[10px] font-bold tracking-[0.2em] opacity-70 mb-1">DATE</div><div class="text-sm font-mono opacity-90" x-text="new Date().toISOString().split('T')[0]"></div></div></div>
        </div>
    </div>

    <div id="shareCardTemplate" style="display: none;" class="fixed top-0 left-0 w-[375px] h-[600px] flex-col items-center justify-center rounded-[24px] overflow-hidden text-center font-sans">
        <img :src="randomShareBg" class="absolute inset-0 w-full h-full object-cover z-0" crossorigin="anonymous">
        <div class="absolute inset-0 z-10 bg-black/40 backdrop-blur-[6px]"></div>
        <div class="relative z-20 w-full p-8 flex flex-col items-center">
            <img src="./images/basic/icon.png" class="w-20 h-20 rounded-full border-4 border-white shadow-xl mb-6">
            <div class="bg-white/95 p-8 rounded-[32px] w-full shadow-2xl backdrop-blur-md border border-white/50">
                <div class="text-xs font-black text-pink-500 uppercase tracking-widest mb-3">å•é¡Œ</div>
                <p id="shareCardQ" class="font-bold text-gray-900 mb-6 text-xl leading-relaxed"></p>
                <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <div class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">ç­”æ¡ˆ</div>
                <p id="shareCardA" class="text-pink-600 font-bold text-2xl leading-relaxed"></p>
            </div>
        </div>
    </div>

    <div id="examPaperTemplate" style="display: none;" class="fixed top-0 left-0 w-[375px] h-[600px] flex flex-col bg-white overflow-hidden font-sans rounded-[24px]">
        
        <div class="bg-theme h-32 relative flex flex-col items-center justify-center shrink-0 z-10">
            <div class="z-10 text-center -mt-4">
                <div class="text-white/90 text-[10px] font-bold tracking-[0.4em] mb-1">OFFICIAL EXAM</div>
                <div class="text-white text-4xl font-black tracking-widest drop-shadow-md">é¹¿ğŸ¦Œå¤§æœƒè€ƒ</div>
            </div>
            <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 w-16 h-16 bg-white rounded-full p-1 border-[5px] border-theme shadow-lg flex items-center justify-center z-20">
                <span class="text-3xl pb-1">ğŸ“</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col px-6 pt-12 pb-6 w-full relative z-0">
            <div class="absolute inset-0 z-0">
                 <img :src="randomShareBg" class="w-full h-full object-cover object-center opacity-20" crossorigin="anonymous">
                 <div class="absolute inset-0 bg-white/40 backdrop-blur-[2px]"></div>
            </div>

            <div class="relative z-10 flex flex-col h-full">
                <div class="flex justify-between items-end border-b-2 border-dashed border-gray-400/30 pb-2 mb-4 shrink-0">
                    <div class="text-gray-500 text-[10px] font-bold tracking-wider">æ—¥æœŸï¼š <span x-text="examDate"></span></div>
                    <div class="font-bold text-base text-gray-700">æˆç¸¾å–®</div>
                </div>

                <div class="bg-white/80 backdrop-blur-md rounded-2xl p-5 mb-4 flex justify-between items-center border border-white/50 shadow-sm">
                    <div class="flex-1 pr-2 min-w-0">
                        <div class="text-[10px] text-gray-400 font-bold tracking-widest mb-1 uppercase">Name</div>
                        <div class="font-black text-2xl text-gray-800 break-words leading-tight" x-text="quizTakerName"></div>
                    </div>
                    <div class="text-right pl-4 border-l-2 border-gray-100">
                        <div class="text-[10px] text-gray-400 font-bold tracking-widest mb-1 uppercase">Score</div>
                        <div class="font-black text-5xl text-theme" x-text="quizScore * 10"></div>
                    </div>
                </div>

                <div class="bg-white/80 backdrop-blur-md border-2 border-theme/20 rounded-xl p-3 mb-4 relative overflow-hidden flex flex-col justify-center items-center shrink-0 min-h-[90px] shadow-sm">
                    <div class="text-4xl mb-2 mt-1 transform hover:scale-110 transition-transform" x-text="quizScore === 5 ? 'ğŸ‘‘' : (quizScore >= 3 ? 'ğŸ‘' : 'ğŸ¤¡')"></div>
                    <div class="font-bold text-base text-gray-800 text-center px-2" x-text="quizScore === 5 ? 'å¤ªç¥å•¦ï¼å®Œç¾å…¨å°ï¼' : (quizScore >= 3 ? 'é‚„ä¸éŒ¯å–”ï¼Œç¹¼çºŒåŠ æ²¹ï¼' : 'è¦å†å»è¤‡ç¿’QAå–”ï¼')"></div>
                </div>

                <div class="flex-1 w-full relative min-h-[180px] bg-gray-100 rounded-xl overflow-hidden shadow-inner border border-gray-200/50">
                    <img :src="randomShareBg" class="absolute inset-0 w-full h-full object-cover object-top z-0" crossorigin="anonymous">
                </div>
            </div>
        </div>
    </div>

    <script>
        window.isMuted = false;
        window.dateInfo = window.dateInfo || { year: 2024, month: 1, day: 1, birthdayDiff: 0, daysTikTok: 0, daysIG: 0, isBirthdayClose: false };
        window.currentOptions = {};

        window.playSound = function() {
            if (window.isMuted) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } catch (e) {}
        };
        window.playClickSound = window.playSound;

        function deerApp() {
            return {
                currentTab: 'home',
                isDark: false,
                isMuted: false,
                showTutorial: false,
                tutorialStep: 0,
                search: '',
                installPrompt: null,
                scrollY: 0,
                
                // ID Card & Background
                idCardName: '',
                selectedBg: '', 
                generatedIdNumber: 'D1003' + Math.floor(Math.random()*9000+1000),
                
                backgrounds: [
                    'https://images.unsplash.com/photo-1557683316-973673baf926?w=400&q=80',
                    'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400&q=80'
                ],
                randomShareBg: '', // Initialized later

                // UI States
                showShareModal: false,
                showUpdateModal: false,
                showToast: false,
                showBgSelectorModal: false, // New: Background Selector
                toastMessage: '',
                themes: [{name: 'pink', color: '#ec4899', light: '#fce7f3'}],
                currentTheme: {name: 'pink', color: '#ec4899', light: '#fce7f3'},
                
                // Data (Fallback)
                qaData: [
                    { q: "éº‹é¹¿çš„èº«é«˜æ˜¯å¤šå°‘ï¼Ÿ", a: "æˆ‘æ˜¯ 170cm å–”ï¼", tags: ["èº«é«˜"] },
                    { q: "éº‹é¹¿çš„ç”Ÿæ—¥æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ", a: "æˆ‘çš„ç”Ÿæ—¥æ˜¯ 10æœˆ3æ—¥ï¼Œå¤©ç§¤åº§ï¼", tags: ["ç”Ÿæ—¥"] },
                    { q: "æœ‰é¤Šå¯µç‰©å—ï¼Ÿ", a: "æœ‰å–”ï¼æˆ‘æœ‰ä¸€éš»è‹±åœ‹çŸ­æ¯›è²“å«åšã€Œå“ºåš•ã€ğŸˆ", tags: ["å¯µç‰©"] },
                    { q: "å–œæ­¡åƒä»€éº¼ï¼Ÿ", a: "è¶…æ„›ç”œé»ï¼Œç‰¹åˆ¥æ˜¯è‰è“è›‹ç³•ï¼", tags: ["é£Ÿç‰©"] },
                    { q: "MBTI æ˜¯ä»€éº¼ï¼Ÿ", a: "ENFP å¿«æ¨‚å°ç‹—ï¼", tags: ["MBTI"] }
                ],
                quizData: [
                    { q: "éº‹é¹¿çš„ç”Ÿæ—¥æ˜¯å¹¾è™Ÿï¼Ÿ", a: "10/03", options: ["10/03", "12/25", "01/01", "08/07"] },
                    { q: "éº‹é¹¿çš„è²“å’ªå«ä»€éº¼åå­—ï¼Ÿ", a: "å“ºåš•", options: ["å’ªå’ª", "å“ºåš•", "çƒçƒ", "è±†è±†"] },
                    { q: "éº‹é¹¿çš„èº«é«˜æ˜¯ï¼Ÿ", a: "170cm", options: ["160cm", "165cm", "170cm", "175cm"] },
                    { q: "éº‹é¹¿çš„ MBTI æ˜¯ï¼Ÿ", a: "ENFP", options: ["INTJ", "ENFP", "ISFP", "ENTP"] }
                ],
                
                // App State
                dateInfo: {},
                paginatedData: [],
                currentPage: 1,
                totalPages: 1,
                flippedCards: [],
                fanXP: 1500,
                xpPercentage: 75,
                currentLevelInfo: { title: "é»ƒé‡‘é¹¿ç²‰" },
                chatInput: '',
                chatHistory: [{ id: 1, text: "å“ˆå›‰ï¼æˆ‘æ˜¯ AI éº‹é¹¿ ğŸ¦Œ\nä½ å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼é¹¿çš„å•é¡Œå–”ï¼", isUser: false, originalQ: "System Welcome", accuracy: 100 }],
                isTyping: false,
                aiStatus: 'online',
                wakeUpCount: 0,
                isListening: false,
                showMsgDetail: false,
                selectedMsg: {},
                quizStarted: false,
                quizEnded: false,
                quizTakerName: '',
                currentQuizIndex: 0,
                quizScore: 0,
                currentQuizSet: [],
                currentQuestion: null,
                currentOptions: [],
                hasAnswered: false,
                selectedOption: null,
                examDate: '',
                fuseInstance: null,

                initApp() {
                    let rawData = window.qaData || this.qaData;
                    this.qaData = rawData.map((item, index) => ({ ...item, id: index + 1 }));
                    
                    if(typeof Fuse !== 'undefined') {
                        this.fuseInstance = new Fuse(this.qaData, { includeScore: true, keys: ['q', 'tags'] });
                    }

                    this.examDate = new Date().toLocaleDateString();
                    this.randomShareBg = this.backgrounds[0];
                    this.selectedBg = this.backgrounds[0];
                    
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    const nextBirthday = new Date(currentYear, 9, 3);
                    if (today > nextBirthday) nextBirthday.setFullYear(currentYear + 1);
                    this.dateInfo.birthdayDiff = Math.ceil(Math.abs(nextBirthday - today) / (1000 * 60 * 60 * 24)); 
                    this.dateInfo.isBirthdayClose = this.dateInfo.birthdayDiff < 30;
                    this.dateInfo.daysTikTok = Math.floor((today - new Date(2024, 7, 7)) / (1000 * 60 * 60 * 24));
                    this.dateInfo.daysIG = Math.floor((today - new Date(2024, 5, 2)) / (1000 * 60 * 60 * 24));

                    this.updatePaginatedData();
                    this.fetchRepoImages(); 
                },

                handleScroll() { this.scrollY = window.scrollY; },

                async imageUrlToBase64(url) {
                    try {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) {
                        console.error("Image convert failed", e);
                        return url;
                    }
                },

                async fetchRepoImages() {
                    const owner = 'wangleoncom';  
                    const repo = 'ldweb';         
                    const path = 'images/backgrounds'; 
                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

                    try {
                        const response = await fetch(apiUrl);
                        if (response.ok) {
                            const data = await response.json();
                            const images = data
                                .filter(file => file.name.match(/\.(jpg|jpeg|png|gif)$/i))
                                .map(file => file.download_url);

                            if (images.length > 0) {
                                this.backgrounds = images;
                                this.selectedBg = images[0]; 
                                this.randomShareBg = images[Math.floor(Math.random() * images.length)];
                            }
                        }
                    } catch (e) { console.warn("GitHub API failed"); }
                },

                async captureElement(elementId, bgUrl) {
                    let finalBg = bgUrl;
                    if (bgUrl.startsWith('http')) {
                        finalBg = await this.imageUrlToBase64(bgUrl);
                    }

                    const originalShareBg = this.randomShareBg;
                    const originalSelectedBg = this.selectedBg;
                    
                    if (elementId === 'idCardTemplate') this.selectedBg = finalBg;
                    else this.randomShareBg = finalBg;

                    await new Promise(r => setTimeout(r, 100));

                    const element = document.getElementById(elementId);
                    if(element) {
                        element.style.display = 'flex';
                        try {
                            const canvas = await html2canvas(element, { 
                                useCORS: true, 
                                allowTaint: true,
                                backgroundColor: null,
                                scale: 2 
                            });
                            const img = canvas.toDataURL("image/png");
                            document.getElementById('shareResultContainer').innerHTML = `<img src="${img}" class="w-full h-full object-contain pointer-events-auto" style="max-height:80vh;">`;
                            this.showShareModal = true;
                        } catch(e) {
                            alert("Generate failed");
                        } finally {
                            element.style.display = 'none';
                            this.randomShareBg = originalShareBg;
                            this.selectedBg = originalSelectedBg;
                        }
                    }
                },

                // --- Features ---
                
                // Show Background Selector for Exam
                promptBgSelection() {
                    this.showBgSelectorModal = true;
                },

                // Actually Generate Image after selection
                async confirmExamImage(bgUrl) {
                    this.showBgSelectorModal = false;
                    await this.captureElement('examPaperTemplate', bgUrl);
                },

                async openShareModal(item) {
                    let targetBg = this.backgrounds.length > 0 
                        ? this.backgrounds[Math.floor(Math.random() * this.backgrounds.length)]
                        : this.randomShareBg;

                    document.getElementById('shareCardQ').innerText = item.q;
                    document.getElementById('shareCardA').innerText = item.a;
                    await this.captureElement('shareCardTemplate', targetBg);
                },

                async generateIDCard() {
                    if(!this.idCardName) { alert("Please enter name!"); return; }
                    this.generatedIdNumber = 'D' + Math.floor(100000 + Math.random() * 900000);
                    await this.captureElement('idCardTemplate', this.selectedBg);
                },

                toggleCard(id) { if (this.flippedCards.includes(id)) { this.flippedCards = this.flippedCards.filter(cid => cid !== id); } else { this.flippedCards.push(id); } },
                updatePaginatedData() { this.paginatedData = this.qaData.slice(0, 6); }, 
                nextPage() { /* ... */ },
                prevPage() { /* ... */ },
                calculateLevel(xp) { return Math.floor(xp / 100); },
                startQuizMode() { this.changeTab('quiz'); },
                startQuiz() { if(!this.quizTakerName) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; } this.quizStarted = true; this.quizEnded = false; this.quizScore = 0; this.currentQuizIndex = 0; this.currentQuizSet = (window.quizData||this.quizData).sort(()=>0.5-Math.random()).slice(0,5); this.loadQuestion(); },
                loadQuestion() { this.currentQuestion = this.currentQuizSet[this.currentQuizIndex]; this.currentOptions = this.currentQuestion.options.sort(()=>0.5-Math.random()); this.hasAnswered = false; this.selectedOption = null; },
                checkAnswer(opt) { if(this.hasAnswered) return; this.hasAnswered = true; this.selectedOption = opt; if(opt === this.currentQuestion.a) { this.quizScore++; } },
                nextQuestion() { 
                    if(this.currentQuizIndex < this.currentQuizSet.length - 1) { 
                        this.currentQuizIndex++; this.loadQuestion(); 
                    } else { 
                        this.quizEnded = true; 
                        // Instead of auto-generating, prompt for background selection
                        this.promptBgSelection();
                    } 
                },
                changeTab(tab) { this.currentTab = tab; window.scrollTo({top: 0, behavior: 'smooth'}); if(tab === 'quiz') this.quizStarted = false; },
                sendMessage() { /* ... */ },
                openMsgDetail(msg) { this.selectedMsg = msg; this.showMsgDetail = true; },
                startVoiceInput() { alert("Voice feature simulated"); },
                wakeUpAI() { this.wakeUpCount++; },
                toggleMute() { this.isMuted = !this.isMuted; },
                toggleDarkMode() { document.documentElement.classList.toggle('dark'); },
                setTheme(t) { this.currentTheme = t; },
                triggerEasterEgg() {},
                installPWA() {},
                closeUpdateModal() {},
                endTutorial() {},
                nextTutorialStep() {}
            }
        }
    </script>

    <div class="fixed inset-0 overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-400/20 rounded-full mix-blend-screen filter blur-[100px] animate-blob"></div>
        <div class="absolute top-[20%] right-[-10%] w-[400px] h-[400px] bg-yellow-300/20 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] bg-pink-400/20 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-4000"></div>
    </div>

    <nav class="fixed top-0 w-full z-40 transition-all duration-500 border-b border-transparent"
         :class="scrollY > 20 ? 'glass-premium shadow-sm border-white/20' : 'bg-transparent'">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center cursor-pointer ios-btn flex-shrink-0" @click="changeTab('home'); window.playSound()">
                <img src="./images/basic/icon.png" class="w-9 h-9 rounded-full mr-2 border-2 border-theme object-cover shadow-sm">
                <span class="font-bold text-xl text-gray-800 dark:text-white tracking-wide">é¹¿ QA</span>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
                <button @click="toggleMute; window.playSound()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 ios-btn transition-colors" :class="{'opacity-50': isMuted}"><span x-text="isMuted ? 'ğŸ”‡' : 'ğŸ”Š'"></span></button>
                <button @click="toggleDarkMode; window.playSound()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 ios-btn transition-colors"><span x-text="isDark ? 'â˜€ï¸' : 'ğŸŒ™'"></span></button>
            </div>
        </div>
    </nav>

    <div class="fixed bottom-6 left-0 right-0 z-50 flex justify-center px-4 safe-area-bottom">
        <nav class="flex items-center gap-1 overflow-x-auto no-scrollbar bg-white/20 dark:bg-black/40 backdrop-blur-2xl border border-white/20 shadow-2xl rounded-[2rem] p-1.5 w-full max-w-md mx-auto ring-1 ring-white/10">
            <button @click="changeTab('home'); window.playSound()" :class="currentTab === 'home' ? 'bg-white text-pink-600 font-bold shadow-md' : 'text-gray-500 dark:text-white/60 hover:bg-white/10 hover:text-white font-medium'" class="ios-btn flex-shrink-0 px-6 py-3 rounded-[1.5rem] transition-all duration-300 whitespace-nowrap text-sm">é¦–é </button>
            <button @click="changeTab('ai'); window.playSound()" :class="currentTab === 'ai' ? 'bg-white text-pink-600 font-bold shadow-md' : 'text-gray-500 dark:text-white/60 hover:bg-white/10 hover:text-white font-medium'" class="ios-btn flex-shrink-0 px-6 py-3 rounded-[1.5rem] transition-all duration-300 whitespace-nowrap text-sm">AI èŠå¤©</button>
            <button @click="startQuizMode(); window.playSound()" :class="currentTab === 'quiz' ? 'bg-white text-pink-600 font-bold shadow-md' : 'text-gray-500 dark:text-white/60 hover:bg-white/10 hover:text-white font-medium'" class="ios-btn flex-shrink-0 px-6 py-3 rounded-[1.5rem] transition-all duration-300 whitespace-nowrap text-sm">å¤§æœƒè€ƒ</button>
            <button @click="changeTab('idcard'); window.playSound()" :class="currentTab === 'idcard' ? 'bg-white text-pink-600 font-bold shadow-md' : 'text-gray-500 dark:text-white/60 hover:bg-white/10 hover:text-white font-medium'" class="ios-btn flex-shrink-0 px-6 py-3 rounded-[1.5rem] transition-all duration-300 whitespace-nowrap text-sm">èº«åˆ†è­‰</button>
        </nav>
    </div>

    <main class="pt-24 px-4 max-w-6xl mx-auto min-h-screen">
        <div x-show="installPrompt" x-transition class="mb-6 mx-auto max-w-md glass-premium p-4 rounded-2xl flex items-center justify-between border border-theme shadow-lg">
            <div class="flex items-center"><span class="text-3xl mr-3">ğŸ“²</span><div><div class="font-bold text-gray-800 dark:text-white">å®‰è£ é¹¿ğŸ¦ŒAPP</div><div class="text-xs text-gray-500">åŠ å…¥ä¸»ç•«é¢é«”é©—æ›´ä½³ï¼</div></div></div>
            <button @click="installPWA" class="px-5 py-2 bg-theme text-white rounded-full text-sm font-bold shadow-md hover:opacity-90 ios-btn">å®‰è£</button>
        </div>

        <div x-show="currentTab === 'home'" x-transition.opacity.duration.300ms>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="md:col-span-2 glass-premium rounded-[32px] p-8 border border-white/40 flex flex-col sm:flex-row items-center gap-8 shadow-xl relative overflow-hidden animate-tilt">
                    <div class="relative group z-10"><img src="./images/basic/icon.png" class="w-28 h-28 md:w-32 md:h-32 rounded-full object-cover shadow-2xl border-4 border-white dark:border-gray-700 ios-btn cursor-pointer flex-shrink-0" @click="triggerEasterEgg('profile')"></div>
                    <div class="flex-1 text-center sm:text-left z-10">
                        <h2 class="text-4xl font-black text-gray-900 dark:text-white mb-2 tracking-tight">é¹¿ğŸ¦Œ</h2>
                        <p class="text-gray-600 dark:text-gray-300 font-medium mb-4 leading-relaxed whitespace-pre-line">ğŸ‚ 10/03 å¤©ç§¤åº§ï½œğŸ“ 170cmï½œâš–ï¸ 42kg</p>
                        <div class="flex justify-center sm:justify-start gap-3">
                            <a href="#" class="px-5 py-2 bg-black text-white rounded-full text-sm font-bold shadow-lg ios-btn flex items-center gap-2 hover:bg-gray-800">TikTok</a>
                            <a href="#" class="px-5 py-2 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-600 text-white rounded-full text-sm font-bold shadow-lg ios-btn flex items-center gap-2 hover:opacity-90">Instagram</a>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-6">
                    <div class="glass-premium rounded-[32px] p-6 border border-white/40 shadow-xl flex flex-col justify-center items-center relative overflow-hidden">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">ç²‰çµ²ç­‰ç´š</div>
                        <div class="text-3xl font-black text-theme mb-1">é»ƒé‡‘é¹¿ç²‰</div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-2 overflow-hidden relative"><div class="bg-theme h-4 rounded-full transition-all duration-1000 ease-out relative overflow-hidden" :style="`width: ${xpPercentage}%`"></div></div>
                    </div>
                </div>
            </div>
            <div class="sticky top-20 z-30 mb-8 transition-all duration-500 ease-out" :class="scrollY > 150 ? 'pt-2 px-2' : ''">
                <div class="relative max-w-2xl mx-auto transition-all duration-300" :class="scrollY > 150 ? 'shadow-2xl scale-[0.98]' : 'shadow-lg'">
                    <div class="absolute inset-0 rounded-2xl bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl transition-all duration-500"></div>
                    <input type="text" x-model="search" @input="currentPage = 1; updatePaginatedData()" placeholder="ğŸ” æœå°‹å•é¡Œ..." class="relative w-full pl-6 pr-6 py-4 rounded-2xl bg-transparent border-2 border-transparent focus:border-theme focus:ring-0 text-lg transition-all placeholder-gray-400 dark:text-white">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 min-h-[400px]">
                <template x-for="(item, index) in paginatedData" :key="item.id">
                    <div class="group h-60 perspective-1000 cursor-pointer animate-pop-in" :style="`animation-delay: ${index * 40}ms`" @click="toggleCard(item.id); window.playSound()">
                        <div class="relative w-full h-full transform-style-3d transition-all duration-500 shadow-md hover:shadow-2xl rounded-[24px] ios-btn" :class="{ 'rotate-y-180': flippedCards.includes(item.id) }">
                            <div class="absolute w-full h-full glass-premium rounded-[24px] p-6 flex flex-col justify-between backface-hidden border-t-2 border-white/60 bg-gradient-to-br from-white/90 to-white/50 dark:from-gray-800/90 dark:to-gray-900/50">
                                <div>
                                    <div class="flex items-center gap-2 mb-3"><span class="text-[10px] font-black tracking-widest text-white bg-theme px-2 py-1 rounded-md">Q.<span x-text="item.id"></span></span><span x-show="item.tags && item.tags[0]" class="text-[10px] bg-gray-100 dark:bg-gray-700 text-gray-500 px-2 py-1 rounded-md" x-text="item.tags ? item.tags[0] : ''"></span></div>
                                    <h3 class="text-lg font-bold leading-snug text-gray-800 dark:text-gray-100 line-clamp-3" x-text="item.q"></h3>
                                </div>
                                <div class="flex justify-between items-end"><div class="text-xs text-gray-400 font-bold uppercase tracking-wider flex items-center">Tap to Flip <span class="ml-1 text-lg">âœ</span></div></div>
                            </div>
                            <div class="absolute w-full h-full glass-premium rounded-[24px] p-6 flex flex-col backface-hidden rotate-y-180 bg-white dark:bg-gray-800 border-b-4 border-theme overflow-y-auto">
                                <div class="flex-1 flex items-center justify-center"><p class="text-[17px] font-medium text-center leading-relaxed text-gray-700 dark:text-gray-200" x-text="item.a"></p></div>
                                <button @click.stop="openShareModal(item); window.playSound()" class="w-full mt-3 flex justify-center items-center gap-2 text-xs text-theme bg-theme-light dark:bg-gray-700 px-4 py-3 rounded-xl font-bold hover:opacity-80 transition-colors ios-btn"><span class="text-lg">ğŸ“¸</span> ç”Ÿæˆç¾åœ–åˆ†äº«</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="currentTab === 'ai'" x-cloak class="max-w-2xl mx-auto h-[70vh] flex flex-col glass-premium rounded-[32px] overflow-hidden shadow-2xl relative border border-white/40 animate-pop-in">
            <div class="absolute inset-0 z-0 bg-white/70 dark:bg-gray-900/80 backdrop-blur-[8px]"></div>
            <div class="relative z-10 bg-white/60 dark:bg-black/40 backdrop-blur-md p-4 flex items-center border-b border-gray-200/20">
                <img src="./images/basic/AI.png" class="w-10 h-10 rounded-full object-cover mr-3 bg-white p-0.5 shadow-md flex-shrink-0">
                <div><h3 class="font-bold text-gray-800 dark:text-gray-100">AI éº‹é¹¿</h3><div class="text-xs text-green-500 font-bold flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span> Online</div></div>
            </div>
            <div class="relative z-10 flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth" id="chatContainer">
                <template x-for="msg in chatHistory" :key="msg.id">
                    <div class="flex w-full animate-pop-in" :class="msg.isUser ? 'justify-end' : 'justify-start'">
                        <div @click="openMsgDetail(msg)" class="max-w-[85%] rounded-2xl px-5 py-3 shadow-sm text-[15px] leading-relaxed cursor-pointer transition-transform active:scale-95" :class="msg.isUser ? 'bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-br-none' : 'bg-white/90 dark:bg-gray-700/90 text-gray-800 dark:text-gray-100 rounded-bl-none border border-white/20 hover:bg-gray-50 dark:hover:bg-gray-600'">
                            <p x-text="msg.text" class="whitespace-pre-line"></p>
                            <div x-show="!msg.isUser && msg.accuracy" class="text-[10px] text-gray-400 mt-1 text-right flex items-center justify-end gap-1"><span>â„¹ï¸</span> é»æ“ŠæŸ¥çœ‹ä¾†æº</div>
                        </div>
                    </div>
                </template>
            </div>
            <div class="relative z-10 p-4 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-t border-gray-200/20">
                <form @submit.prevent="sendMessage; window.playSound()" class="flex gap-2">
                    <button type="button" @click="startVoiceInput; window.playSound()" class="rounded-full w-12 h-12 flex items-center justify-center transition-all ios-btn bg-gray-200 dark:bg-gray-700 text-gray-500"><span class="text-xl">ğŸ™ï¸</span></button>
                    <input type="text" x-model="chatInput" placeholder="å•å•é¡Œæˆ–æŒ‰éº¥å…‹é¢¨..." class="flex-1 rounded-full bg-gray-100 dark:bg-gray-800 border-none focus:ring-2 focus:ring-theme px-5 py-3 transition-all">
                    <button type="submit" class="bg-theme hover:opacity-90 text-white rounded-full p-3 w-12 h-12 flex items-center justify-center shadow-lg ios-btn">â¤</button>
                </form>
            </div>
            <div x-show="showMsgDetail" class="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-6" x-transition.opacity x-cloak @click.self="showMsgDetail = false">
                <div class="bg-white dark:bg-gray-800 rounded-[24px] p-6 w-full max-w-sm shadow-2xl border border-white/20 animate-pop-in relative">
                    <button @click="showMsgDetail = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
                    <h3 class="text-lg font-black text-theme mb-4 flex items-center gap-2"><span>ğŸ¤–</span> AI æ€è€ƒé‚è¼¯</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl"><div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">åŒ¹é…åˆ°çš„åŸå§‹å•é¡Œ (Q)</div><p class="font-bold text-gray-800 dark:text-white text-lg" x-text="selectedMsg.originalQ || 'N/A'"></p></div>
                        <div class="flex items-center gap-4"><div class="flex-1 bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl"><div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">AI ä¿¡å¿ƒæŒ‡æ•¸</div><div class="flex items-end gap-1"><span class="font-black text-3xl text-theme" x-text="selectedMsg.accuracy || 0"></span><span class="text-sm font-bold text-gray-500 mb-1">%</span></div></div></div>
                    </div>
                    <button @click="showMsgDetail = false" class="w-full mt-6 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-full font-bold text-sm transition-colors ios-btn">äº†è§£ï¼</button>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'quiz'" x-cloak class="max-w-2xl mx-auto">
            <div x-show="!quizStarted && !quizEnded" class="text-center py-12 glass-premium rounded-[32px] p-8 shadow-2xl animate-pop-in">
                <div class="text-8xl mb-4 animate-float drop-shadow-xl">ğŸ“</div>
                <h2 class="text-4xl font-black mb-2 text-gray-800 dark:text-white tracking-tight">éº‹é¹¿å¤§æœƒè€ƒ 2.0</h2>
                <div class="max-w-xs mx-auto mb-8 relative"><label class="block text-left text-xs font-bold text-gray-500 mb-2 ml-4 uppercase tracking-wider">è€ƒç”Ÿå§“å</label><input type="text" x-model="quizTakerName" placeholder="è¼¸å…¥åå­—é–‹å§‹è€ƒè©¦..." class="w-full px-6 py-4 rounded-2xl bg-white/50 dark:bg-black/30 border-2 border-gray-200 dark:border-gray-700 focus:border-theme focus:ring-4 focus:ring-theme/20 text-center text-xl font-bold transition-all outline-none placeholder-gray-400"></div>
                <button @click="startQuiz; window.playSound()" class="w-full max-w-xs px-12 py-4 bg-gradient-to-r from-theme to-purple-600 text-white rounded-2xl font-black text-xl shadow-xl ios-btn hover:scale-105 transition-transform flex items-center justify-center mx-auto"><span>é–‹å§‹æŒ‘æˆ°</span><span class="ml-2">âœ</span></button>
            </div>
            <div x-show="quizStarted && !quizEnded" class="animate-pop-in">
                <div class="flex justify-between items-center mb-6 px-4"><span class="font-bold text-white bg-theme px-4 py-1.5 rounded-full text-sm">Q.<span x-text="currentQuizIndex + 1"></span></span><span class="text-sm font-bold bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full">åˆ†æ•¸: <span x-text="quizScore"></span></span></div>
                <div class="glass-premium rounded-3xl p-8 mb-6 border-l-8 border-theme min-h-[180px] flex items-center justify-center relative shadow-lg"><h3 class="text-2xl font-bold text-center leading-relaxed text-gray-800 dark:text-white" x-text="currentQuestion?.q"></h3></div>
                <div class="grid grid-cols-1 gap-4">
                    <template x-for="(opt, idx) in currentOptions" :key="idx"><button @click="checkAnswer(opt); window.playSound()" :disabled="hasAnswered" class="w-full p-5 rounded-2xl text-left font-bold transition-all border-2 shadow-sm flex items-center justify-between group ios-btn" :class="hasAnswered ? (opt === currentQuestion.a ? 'border-green-500 bg-green-50 dark:bg-green-900/30' : (selectedOption === opt ? 'border-red-500 bg-red-50 dark:bg-red-900/30' : 'border-gray-200')) : 'border-gray-200 hover:border-theme bg-white/50'"><div class="flex items-center"><span class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-sm mr-4 font-black" x-text="['A','B','C','D'][idx]"></span><span x-text="opt"></span></div></button></template>
                </div>
                <button x-show="hasAnswered" @click="nextQuestion; window.playSound()" class="mt-8 w-full py-4 bg-gray-800 dark:bg-gray-700 text-white rounded-2xl font-bold shadow-lg ios-btn text-lg"><span x-text="currentQuizIndex === currentQuizSet.length - 1 ? 'æŸ¥çœ‹æˆç¸¾' : 'ä¸‹ä¸€é¡Œ'"></span> âœ</button>
            </div>
            <div x-show="quizEnded" class="text-center py-10 glass-premium rounded-[32px] p-6 shadow-2xl relative animate-pop-in">
                <h2 class="text-3xl font-black mb-4">è€ƒè©¦çµæœå‡ºçˆï¼ğŸ“„</h2>
                <div class="text-sm text-gray-500 mb-4">è«‹é¸æ“‡ä¸€å¼µå–œæ­¡çš„èƒŒæ™¯...</div>
            </div>
        </div>

        <div x-show="currentTab === 'idcard'" x-cloak class="max-w-2xl mx-auto">
            <div class="glass-premium rounded-[32px] p-8 shadow-2xl animate-pop-in">
                <h2 class="text-3xl font-black mb-8 text-center text-theme">éº‹é¹¿èªè­‰ä¸­å¿ƒ ğŸªª</h2>
                <div class="space-y-6 mb-10">
                    <div><label class="block text-sm font-bold text-gray-500 mb-2 uppercase">ä½ çš„æš±ç¨±</label><input type="text" x-model="idCardName" placeholder="è¼¸å…¥æš±ç¨±..." class="w-full px-5 py-4 rounded-2xl bg-white/50 dark:bg-black/30 border border-gray-200 dark:border-gray-700 focus:border-theme focus:ring-0 text-lg"></div>
                    <div><label class="block text-sm font-bold text-gray-500 mb-2 uppercase">é¸æ“‡èƒŒæ™¯</label>
                        <div class="grid grid-cols-3 gap-3">
                            <template x-for="(bg, index) in backgrounds" :key="index"><div @click="selectedBg = bg; window.playSound()" class="aspect-[3/4] rounded-xl overflow-hidden cursor-pointer border-4 transition-all bg-cover bg-center" :class="selectedBg === bg ? 'border-theme scale-95' : 'border-transparent opacity-80 hover:opacity-100'" :style="`background-image: url(${bg})`"></div></template>
                        </div>
                    </div>
                </div>
                <button @click="generateIDCard; window.playSound()" class="w-full py-4 bg-gradient-to-r from-theme to-pink-600 text-white rounded-2xl font-bold shadow-xl ios-btn text-lg flex items-center justify-center"><span class="mr-2">âœ¨</span> ç”Ÿæˆèº«åˆ†è­‰</button>
            </div>
        </div>

        <div x-show="showBgSelectorModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 p-6 backdrop-blur-md" x-cloak x-transition.opacity>
            <div class="bg-white dark:bg-gray-800 rounded-[32px] p-6 max-w-sm w-full flex flex-col items-center animate-pop-in relative">
                <div class="text-xl font-bold text-gray-800 mb-4">é¸æ“‡æˆç¸¾å–®ç…§ç‰‡ ğŸ“¸</div>
                <div class="grid grid-cols-2 gap-3 w-full mb-6 max-h-[50vh] overflow-y-auto p-1">
                    <template x-for="bg in backgrounds" :key="bg">
                        <div @click="confirmExamImage(bg)" class="aspect-[3/4] rounded-xl overflow-hidden cursor-pointer border-2 border-transparent hover:border-theme transition-all shadow-md">
                            <img :src="bg" class="w-full h-full object-cover">
                        </div>
                    </template>
                </div>
                <button @click="showBgSelectorModal = false" class="text-sm text-gray-500 hover:text-gray-800">å–æ¶ˆ</button>
            </div>
        </div>

        <div x-show="showShareModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 p-6 backdrop-blur-md" x-cloak x-transition.opacity>
            <div class="bg-white dark:bg-gray-800 rounded-[32px] p-6 max-w-sm w-full flex flex-col items-center animate-pop-in relative">
                <div class="absolute -top-12 text-white font-bold text-sm tracking-widest opacity-80">é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ“¸</div>
                <div id="shareResultContainer" class="mb-6 shadow-2xl rounded-2xl overflow-hidden w-full bg-gray-100 min-h-[300px] flex items-center justify-center"></div>
                <button @click="showShareModal = false; window.playSound()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-full font-bold text-sm transition-colors ios-btn">é—œé–‰</button>
            </div>
        </div>
    </main>
    
    <script>if ('serviceWorker' in navigator && location.protocol.startsWith('http')) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {})); }</script>
</body>
</html>