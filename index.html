<!DOCTYPE html>
<html lang="zh-TW" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¹¿ğŸ¦ŒQAç¶²ç«™</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./images/basic/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="./images/basic/icon.png">
    <meta name="theme-color" content="#fdf2f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é¹¿ QA">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Rounded+Mplus+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="./deer_db.js"></script>
    <script src="./quiz_db.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW å¤±æ•—', err));
            });
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Rounded Mplus 1c"', '"Noto Sans TC"', 'sans-serif'] },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'blob': 'blob 15s infinite',
                        'spin-slow': 'spin 4s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'popup': 'popup 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    colors: { glass: { 100: 'rgba(255, 255, 255, 0.25)', 200: 'rgba(255, 255, 255, 0.45)' } },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0) rotate(0deg)' }, '50%': { transform: 'translateY(-20px) rotate(2deg)' } },
                        blob: { "0%": { transform: "translate(0px, 0px) scale(1)" }, "33%": { transform: "translate(30px, -50px) scale(1.1)" }, "66%": { transform: "translate(-20px, 20px) scale(0.9)" }, "100%": { transform: "translate(0px, 0px) scale(1)" } },
                        popup: { "0%": { transform: "scale(0.9) translateY(20px)", opacity: 0 }, "100%": { transform: "scale(1) translateY(0)", opacity: 1 } },
                        slideUp: { "0%": { transform: "translateY(100%)", opacity: 0 }, "100%": { transform: "translateY(0)", opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Rounded Mplus 1c', sans-serif; background-color: #f0f2f5; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .liquid-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background: radial-gradient(circle at 50% 50%, #fdf4ff 0%, #e0e7ff 100%); }
        .liquid-blob { position: absolute; filter: blur(90px); opacity: 0.7; will-change: transform; }
        .glass-panel { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); }
        .glass-nav { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* éš±è—åŸç”Ÿ select çš„ç®­é ­ */
        .appearance-none { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body class="text-slate-800 transition-colors duration-500 min-h-screen selection:bg-pink-200"
      x-data="deerApp()" x-init="initApp()">

    <div x-show="isLoading" 
         class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white/90 backdrop-blur-3xl transition-opacity duration-700"
         x-transition:leave="opacity-0 pointer-events-none">
        <div class="relative w-36 h-36 mb-6 flex items-center justify-center">
            <div class="absolute inset-0 rounded-full border-[6px] border-pink-100/50 animate-ping"></div>
            <div class="absolute inset-0 rounded-full border-[6px] border-t-pink-500 border-r-purple-500 border-b-transparent border-l-transparent animate-spin"></div>
            <img src="./images/basic/icon.png" class="relative z-10 w-28 h-28 rounded-full object-cover shadow-lg">
        </div>
        <div class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-br from-pink-500 to-purple-600 tracking-wider mb-2">é¹¿ğŸ¦ŒQAç¶²ç«™</div>
        <div class="text-xs font-bold text-slate-400 tracking-[0.2em]">ç³»çµ±è¼‰å…¥ä¸­...</div>
        <div class="mt-8 w-64 h-1.5 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-pink-400 to-purple-500 transition-all duration-300" :style="`width: ${loadProgress}%`"></div>
        </div>
    </div>

    <div x-show="isProcessing" class="fixed inset-0 z-[9998] flex items-center justify-center bg-black/20 backdrop-blur-sm" x-cloak>
        <div class="bg-white/90 p-6 rounded-3xl shadow-2xl flex flex-col items-center animate-popup">
            <div class="w-10 h-10 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-sm font-bold text-slate-600">åœ–ç‰‡ç”Ÿæˆä¸­...</span>
        </div>
    </div>

    <div class="liquid-bg">
        <div class="liquid-blob bg-pink-300 w-[600px] h-[600px] rounded-full top-[-10%] left-[-20%] animate-blob mix-blend-multiply"></div>
        <div class="liquid-blob bg-purple-300 w-[600px] h-[600px] rounded-full top-[20%] right-[-20%] animate-blob animation-delay-2000 mix-blend-multiply"></div>
        <div class="liquid-blob bg-blue-200 w-[500px] h-[500px] rounded-full bottom-[-10%] left-[10%] animate-blob animation-delay-4000 mix-blend-multiply"></div>
    </div>

    <nav class="fixed top-0 w-full z-40 transition-all duration-500" :class="scrollY > 10 ? 'glass-nav py-3' : 'bg-transparent py-6'">
        <div class="max-w-[90%] w-full mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer group" @click="changeTab('home'); playSound('click')">
                <div class="relative">
                     <img src="./images/basic/icon.png" class="w-10 h-10 rounded-full border-2 border-white/80 shadow-md object-cover transition-transform group-hover:scale-110">
                     <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-400 rounded-full border-2 border-white animate-pulse-fast"></div>
                </div>
                <div class="flex flex-col">
                    <span class="font-black text-xl text-slate-800 tracking-tight leading-none">é¹¿ QA</span>
                    <span class="text-[9px] font-bold text-slate-400 tracking-widest mt-0.5">ç²‰çµ²è‡ªè£½</span>
                </div>
            </div>
            <button @click="openSettings" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center transition-all shadow-sm hover:shadow-md active:scale-95">
                <svg class="w-5 h-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
        </div>
    </nav>

    <main class="pt-28 px-4 md:px-8 pb-36 w-full mx-auto min-h-screen">
        <div x-show="currentTab === 'home'" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-y-10" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="glass-panel rounded-[2.5rem] p-6 md:p-8 mb-8 relative overflow-hidden group max-w-5xl mx-auto">
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-bl from-pink-300/30 to-transparent rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                    <div class="relative group-hover:scale-105 transition-transform duration-500 cursor-pointer" @click="playSound('success')">
                        <img src="./images/basic/icon.png" class="w-28 h-28 rounded-[2rem] shadow-2xl object-cover border-[3px] border-white">
                        <div class="absolute -bottom-3 -right-3 bg-white/90 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-slate-800 shadow-lg flex items-center gap-1 border border-white">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> åœ¨ç·š
                        </div>
                    </div>
                    <div class="text-center md:text-left flex-1">
                        <h2 class="text-3xl font-black text-slate-800 mb-2">é¹¿ <span class="text-pink-500">ğŸ¦Œ</span></h2>
                        <p class="text-slate-500 font-medium mb-5 text-sm leading-relaxed">
                            10/03 å¤©ç§¤åº§ï½œ170cmï½œ42kg<br>
                            æ”¶éŒ„æ‰€æœ‰é—œæ–¼é¹¿çš„å°ç§˜å¯†èˆ‡ç›´æ’­å¸¸è¦‹å•é¡Œã€‚<br>
                            <span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded-full">ç²‰çµ²è‡ªè£½ç¶²ç«™</span>
                        </p>
                        <div class="flex justify-center md:justify-start gap-3">
    <a href="https://www.tiktok.com/@ld.1003_" target="_blank" class="pl-4 pr-5 py-2.5 bg-black/5 hover:bg-black hover:text-white rounded-full flex items-center gap-2 transition-all duration-300 group">
        <svg class="w-4 h-4 fill-current group-hover:animate-pulse" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
        </svg>
        <span class="font-bold text-xs">TikTok</span>
    </a>

    <a href="https://www.instagram.com/ld.1003_/" target="_blank" class="pl-4 pr-5 py-2.5 bg-gradient-to-tr from-yellow-400/20 via-red-500/20 to-purple-600/20 hover:from-yellow-400 hover:via-red-500 hover:to-purple-600 hover:text-white text-pink-600 rounded-full flex items-center gap-2 transition-all duration-300 group">
        <svg class="w-4 h-4 fill-current group-hover:rotate-12 transition-transform duration-300" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/>
        </svg>
        <span class="font-bold text-xs">Instagram</span>
    </a>
</div>
                    </div>
                </div>
            </div>

            <div class="relative mb-8 group z-20 max-w-5xl mx-auto">
                <input type="text" x-model="search" @input="handleSearch" placeholder="æœå°‹å•é¡Œ... (ä¾‹å¦‚: èº«é«˜ã€ç›´æ’­)" 
                       class="w-full pl-12 pr-6 py-4 rounded-2xl bg-white/60 border border-white/40 focus:border-pink-300 focus:bg-white/90 focus:ring-4 focus:ring-pink-100/50 shadow-sm outline-none transition-all text-base font-bold placeholder-slate-400 text-slate-800 backdrop-blur-md">
            </div>

            <div class="grid gap-5 pb-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 min-[1800px]:grid-cols-7 min-[2200px]:grid-cols-8">
                <template x-for="item in paginatedData" :key="item.id">
                    <div :id="'qa-card-' + item.id" class="group h-56 perspective-1000 cursor-pointer" @click="toggleCard(item.id)">
                        <div class="relative w-full h-full transform-style-3d transition-transform duration-700 shadow-sm hover:shadow-xl rounded-[2rem]" :class="{ 'rotate-y-180': flippedCards.includes(item.id) }">
                            <div class="absolute w-full h-full glass-panel rounded-[2rem] p-7 flex flex-col justify-between backface-hidden bg-white/70">
                                <div>
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-pink-100 text-pink-600 text-xs font-black shadow-inner">Q</span>
                                        <span class="text-[10px] font-bold text-slate-400 bg-white/50 px-2 py-1 rounded-full">#<span x-text="item.id"></span></span>
                                    </div>
                                    <h3 class="text-lg font-bold text-slate-800 leading-snug line-clamp-3" x-text="item.q"></h3>
                                </div>
                                <div class="text-right text-[10px] font-bold text-slate-400 uppercase tracking-widest">é»æ“Šç¿»é çœ‹è§£ç­” â†»</div>
                            </div>
                            <div class="absolute w-full h-full glass-panel rounded-[2rem] p-6 flex flex-col justify-between items-center backface-hidden rotate-y-180 bg-white/90 border-2 border-pink-200/50">
                                <div class="w-full h-full overflow-y-auto no-scrollbar flex items-center justify-center">
                                    <p class="text-base font-medium text-center text-slate-700 leading-relaxed" x-text="item.a"></p>
                                </div>
                                <button @click.stop="openShareModal(item)" class="mt-2 px-4 py-2 bg-slate-50 rounded-full text-[10px] font-bold text-slate-500 hover:bg-pink-50 hover:text-pink-600 transition-colors shadow-sm flex items-center gap-1.5">
                                    åˆ†äº«å¡ç‰‡
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="flex justify-center items-center gap-3 pb-8 mt-4">
                <button @click="prevPage" :disabled="currentPage === 1" class="w-10 h-10 rounded-xl glass-panel flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white text-slate-600 font-bold shadow-sm transition-all">â†</button>
                <div class="px-4 py-2 glass-panel rounded-xl font-bold text-slate-600 shadow-sm text-sm"><span x-text="currentPage"></span> / <span x-text="totalPages"></span></div>
                <button @click="nextPage" :disabled="currentPage === totalPages" class="w-10 h-10 rounded-xl glass-panel flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white text-slate-600 font-bold shadow-sm transition-all">â†’</button>
            </div>
        </div>

        <div x-show="currentTab === 'ai'" x-cloak class="h-[75vh] max-w-4xl mx-auto flex flex-col glass-panel rounded-[2.5rem] overflow-hidden shadow-2xl relative bg-white/50 border-white/60"
             x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            <div class="bg-white/70 backdrop-blur-xl p-4 border-b border-white/50 flex items-center gap-3 z-10">
                <img src="./images/basic/AI.png" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                <div><h3 class="font-black text-slate-800 text-base">AI éº‹é¹¿</h3><div class="text-[10px] font-bold text-slate-400">ç”±éº‹é¹¿æ™ºæ…§æ ¸å¿ƒé©…å‹•</div></div>
            </div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-5 space-y-4 scroll-smooth">
                <template x-for="msg in chatHistory" :key="msg.id">
                    <div class="flex w-full animate-slide-up" :class="msg.isUser ? 'justify-end' : 'justify-start'">
                        <div class="max-w-[85%] px-5 py-3 rounded-2xl shadow-sm text-sm leading-relaxed cursor-pointer"
                             @click="!msg.isUser && openMsgDetail(msg)"
                             :class="msg.isUser ? 'bg-gradient-to-br from-pink-500 to-purple-600 text-white rounded-br-none' : 'bg-white text-slate-800 rounded-bl-none border border-white/60'">
                            <p x-text="msg.text" class="whitespace-pre-line"></p>
                            <div x-show="!msg.isUser && msg.accuracy" class="text-[9px] opacity-60 mt-1 pt-1 border-t border-slate-100/50 flex justify-end gap-1">
                                <span>ä¿¡å¿ƒåº¦</span> <span class="font-black" x-text="msg.accuracy + '%'"></span>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="isTyping" class="flex justify-start animate-pulse"><div class="bg-white/80 px-4 py-3 rounded-2xl rounded-bl-none flex gap-1.5 shadow-sm border border-white"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></div></div></div>
            </div>
            <div class="p-3 bg-white/80 backdrop-blur-xl border-t border-white/50 z-10">
                <div class="relative flex items-center gap-2">
                    <input type="text" x-model="chatInput" @keydown.enter="handleChatEnter" placeholder="è¼¸å…¥å•é¡Œ..." class="flex-1 pl-5 pr-12 py-3 rounded-full bg-slate-100 border-2 border-transparent focus:border-pink-300 focus:bg-white outline-none text-slate-800 shadow-inner text-sm font-medium">
                    <button @click="sendMessage" class="absolute right-1.5 p-2 bg-slate-900 text-white rounded-full shadow-lg hover:bg-pink-600 transition-all active:scale-90" :disabled="!chatInput.trim()">â¤</button>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'quiz'" x-cloak class="max-w-2xl mx-auto" x-transition:enter="transition ease-out duration-500">
            <div x-show="!quizStarted" class="glass-panel rounded-[3rem] p-8 text-center relative overflow-hidden bg-white/60">
                <div class="absolute inset-0 bg-gradient-to-b from-pink-100/40 to-transparent"></div>
                <div class="relative z-10">
                    <div class="text-7xl mb-6 animate-float">ğŸ“</div>
                    <h2 class="text-2xl font-black text-slate-800 mb-3">éº‹é¹¿å¤§æœƒè€ƒ</h2>
                    <p class="text-slate-500 mb-8 font-medium text-sm">è­‰æ˜ä½ æ˜¯éµç²‰çš„æ™‚åˆ»åˆ°äº†ï¼</p>
                    <input type="text" x-model="quizTakerName" placeholder="è¼¸å…¥ä½ çš„åå­—" class="w-full max-w-xs mx-auto mb-6 px-6 py-4 rounded-2xl bg-white border-2 border-slate-100 focus:border-pink-400 outline-none text-center font-bold shadow-sm">
                    <button @click="startQuiz" class="w-full max-w-xs px-8 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl hover:shadow-2xl hover:scale-105 transition-all active:scale-95">é–‹å§‹æŒ‘æˆ°</button>
                </div>
            </div>
            <div x-show="quizStarted" class="glass-panel rounded-[2.5rem] p-8 shadow-xl bg-white/80 border-white">
                <div class="flex justify-between items-center mb-6">
                    <span class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold tracking-widest">Q.<span x-text="currentQuizIndex + 1"></span></span>
                    <div class="h-2 flex-1 mx-4 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                        <div class="h-full bg-gradient-to-r from-pink-500 to-purple-500 transition-all duration-500 rounded-full" :style="`width: ${((currentQuizIndex + 1) / currentQuizSet.length) * 100}%`"></div>
                    </div>
                </div>
                <h3 class="text-xl font-black text-slate-800 mb-8 min-h-[60px] flex items-center justify-center text-center leading-snug" x-text="currentQuestion?.q"></h3>
                <div class="grid gap-3">
                    <template x-for="(opt, idx) in currentOptions" :key="idx">
                        <button @click="checkAnswer(opt)" :disabled="hasAnswered"
                                class="w-full p-4 rounded-xl text-left font-bold transition-all border-2 flex items-center relative overflow-hidden group active:scale-98"
                                :class="hasAnswered ? (opt === currentQuestion.a ? 'bg-green-50 border-green-500 text-green-700' : (selectedOption === opt ? 'bg-red-50 border-red-500 text-red-700' : 'bg-white border-transparent opacity-50')) : 'bg-white border-transparent hover:border-pink-300 hover:bg-pink-50 text-slate-700 shadow-sm'">
                            <span class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] mr-3 font-black text-slate-500 group-hover:bg-white" x-text="['A','B','C','D'][idx]"></span>
                            <span class="text-sm" x-text="opt"></span>
                        </button>
                    </template>
                </div>
                <button x-show="hasAnswered" @click="nextQuestion" class="mt-6 w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold shadow-xl hover:bg-slate-800 transition-all animate-slide-up active:scale-95">
                    <span x-text="currentQuizIndex === currentQuizSet.length - 1 ? 'å®Œæˆæ¸¬é©—' : 'ä¸‹ä¸€é¡Œ'"></span>
                </button>
            </div>
        </div>

        <div x-show="currentTab === 'idcard'" x-cloak class="glass-panel rounded-[3rem] p-8 shadow-xl text-center max-w-md mx-auto bg-white/70">
            <h2 class="text-2xl font-black mb-2 text-slate-800">éº‹é¹¿èªè­‰</h2>
            <p class="text-slate-500 text-xs mb-6">ç”Ÿæˆä½ çš„å°ˆå±¬ç²‰çµ²è­‰æ˜</p>
            <div class="space-y-5 mb-8 text-left">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider pl-2">æš±ç¨±</label>
                    <input type="text" x-model="idCardName" placeholder="è¼¸å…¥åå­—..." class="w-full px-5 py-3 rounded-2xl bg-white border border-transparent focus:border-pink-400 outline-none font-bold shadow-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider pl-2">é¸æ“‡èƒŒæ™¯</label>
                    <div class="grid grid-cols-2 gap-3 max-h-52 overflow-y-auto custom-scrollbar p-1">
                        <template x-for="(bg, idx) in backgrounds" :key="idx">
                            <div @click="selectedBg = bg; playSound('click')" class="aspect-[3/4] rounded-xl overflow-hidden cursor-pointer border-[3px] transition-all relative"
                                 :class="selectedBg === bg ? 'border-pink-500 ring-2 ring-pink-200' : 'border-transparent opacity-70 hover:opacity-100'">
                                <img :src="bg" class="w-full h-full object-cover">
                                <div x-show="selectedBg === bg" class="absolute inset-0 bg-pink-500/20 flex items-center justify-center">
                                    <div class="w-5 h-5 bg-white rounded-full flex items-center justify-center text-pink-500 text-[10px] font-bold">âœ“</div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <button @click="generateIDCard" class="w-full py-3.5 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-2xl font-bold shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all active:scale-95">ç«‹å³ç”Ÿæˆ</button>
        </div>
    </main>

    <div class="fixed bottom-6 left-0 right-0 z-50 px-6 pointer-events-none safe-area-bottom">
        <nav class="pointer-events-auto flex items-center justify-between p-1.5 rounded-[2rem] glass-nav shadow-2xl max-w-xs mx-auto border border-white/50">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="changeTab(tab.id); playSound('click')"
                        class="relative w-full py-3 rounded-[1.8rem] flex flex-col items-center justify-center gap-1 transition-all duration-300 group hover:bg-white/40">
                    <span class="text-xl transition-transform duration-300 group-active:scale-90" :class="currentTab === tab.id ? '-translate-y-1' : 'grayscale opacity-60'" x-text="tab.icon"></span>
                    <span class="text-[9px] font-bold transition-all duration-300 leading-none" :class="currentTab === tab.id ? 'text-slate-800 scale-100' : 'text-slate-400 scale-75 opacity-0 h-0'" x-text="tab.label"></span>
                    <div class="absolute bottom-1 w-1 h-1 rounded-full bg-pink-500 transition-all duration-300" :class="currentTab === tab.id ? 'opacity-100 scale-100' : 'opacity-0 scale-0'"></div>
                </button>
            </template>
        </nav>
    </div>

    <div x-show="modal.isOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-lg p-6" x-cloak>
        <div @click.outside="closeModal" class="bg-white/95 backdrop-blur-xl rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl relative text-center border border-white">
            <div class="w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl shadow-inner" :class="modal.type === 'success' ? 'bg-green-100 text-green-500' : (modal.type === 'update' ? 'bg-blue-100 text-blue-500' : 'bg-slate-100 text-slate-500')">
                <span x-text="modal.type === 'success' ? 'âœ¨' : (modal.type === 'update' ? 'ğŸš€' : 'â„¹ï¸')"></span>
            </div>
            <h3 class="text-xl font-black text-slate-800 mb-3" x-text="modal.title"></h3>
            <div class="text-slate-500 font-medium mb-8 leading-relaxed text-sm whitespace-pre-line" x-text="modal.body"></div>
            
            <template x-if="modal.type === 'share' || modal.type === 'certificate'">
                <div id="shareResult" class="mb-6 rounded-2xl overflow-hidden shadow-lg border-4 border-slate-100 bg-slate-50 min-h-[200px]"></div>
            </template>
            
            <template x-if="modal.type === 'update' && modal.title.includes('æª¢æŸ¥')">
                <button @click="forceUpdate" class="w-full py-3 mb-2 bg-red-50 text-red-500 rounded-2xl font-bold hover:bg-red-100 transition-all text-xs">âš ï¸ å¼·åˆ¶é‡æ–°æ•´ç†èˆ‡ä¿®å¾©</button>
            </template>

            <button @click="closeModal" class="w-full py-3.5 bg-slate-900 text-white rounded-2xl font-bold shadow-lg hover:bg-slate-800 transition-all active:scale-95">é—œé–‰</button>
        </div>
    </div>

    <div x-show="showBgSelectorModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-6" x-transition.opacity x-cloak>
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full shadow-2xl overflow-hidden p-6 text-center">
            <h3 class="text-xl font-black text-slate-800 mb-2">ğŸ‰ æ¸¬é©—å®Œæˆï¼</h3>
            <p class="text-slate-500 text-xs mb-4">è«‹é¸æ“‡ä¸€å¼µå–œæ­¡çš„ç…§ç‰‡åšç‚ºçç‹€èƒŒæ™¯</p>
            <div class="grid grid-cols-2 gap-3 max-h-64 overflow-y-auto custom-scrollbar mb-6">
                <template x-for="(bg, idx) in backgrounds" :key="idx">
                    <div @click="confirmExamImage(bg)" class="aspect-[3/4] rounded-xl overflow-hidden cursor-pointer border-[3px] border-transparent hover:border-pink-500 relative transition-all active:scale-95">
                        <img :src="bg" class="w-full h-full object-cover">
                    </div>
                </template>
            </div>
            <button @click="confirmExamImage(backgrounds[0])" class="text-slate-400 text-xs underline">éš¨æ©Ÿå¹«æˆ‘é¸</button>
        </div>
    </div>

    <div x-show="showSettingsModal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/30 backdrop-blur-sm p-6" x-transition.opacity x-cloak>
        <div @click.outside="showSettingsModal = false" class="bg-white/95 backdrop-blur-2xl rounded-[2.5rem] max-w-sm w-full shadow-2xl overflow-hidden animate-slide-up border border-white">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-black text-lg text-slate-800">ç³»çµ±è¨­å®š</h3>
                <button @click="showSettingsModal = false" class="w-8 h-8 rounded-full bg-slate-200/50 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition-colors">âœ•</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh] custom-scrollbar">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest pl-2">å€‹äººåŒ–</div>
                 <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500">ğŸµ</div>
                         <div class="font-bold text-sm text-slate-700">éŸ³æ•ˆé–‹é—œ</div>
                    </div>
                    <button @click="toggleSound" class="w-12 h-7 rounded-full transition-colors duration-300 relative px-1" :class="settings.sound ? 'bg-green-400' : 'bg-slate-200'">
                        <div class="w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-300" :class="settings.sound ? 'translate-x-5' : 'translate-x-0'"></div>
                    </button>
                </div>
                
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500">ğŸ“ƒ</div>
                         <div>
                             <div class="font-bold text-sm text-slate-700">æ¯é é¡¯ç¤º</div>
                         </div>
                    </div>
                    <select x-model="settings.itemsPerPage" @change="saveSettings" class="bg-slate-100 text-xs font-bold rounded-lg py-1.5 px-3 outline-none border-transparent focus:ring-2 focus:ring-pink-200 text-slate-600 appearance-none">
                        <option value="10">10 ç­†</option>
                        <option value="20">20 ç­†</option>
                        <option value="50">50 ç­†</option>
                        <option value="100">100 ç­†</option>
                    </select>
                </div>

                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest pl-2 mt-2">æ‡‰ç”¨ç¨‹å¼</div>
                <div x-show="deferredPrompt || !isIOS" class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500">ğŸ“²</div>
                        <div class="font-bold text-sm text-slate-700">å®‰è£åˆ°æ¡Œé¢</div>
                    </div>
                    <button @click="installPWA" class="px-3 py-1.5 bg-green-50 text-green-600 text-xs font-bold rounded-full hover:bg-green-100 transition-colors">å®‰è£</button>
                </div>

                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-500">ğŸ“¤</div>
                        <div>
                             <div class="font-bold text-sm text-slate-700">åˆ†äº«ç¶²ç«™</div>
                        </div>
                    </div>
                    <button @click="shareApp" class="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-full hover:bg-blue-50 hover:text-blue-500 transition-colors">åˆ†äº«</button>
                </div>

                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest pl-2 mt-2">é—œæ–¼</div>
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-500">ğŸ”„</div>
                        <div>
                            <div class="font-bold text-sm text-slate-700">ç‰ˆæœ¬ v<span x-text="appVersion"></span></div>
                            <div class="text-[10px] text-slate-400">é»æ“Šå³å´æª¢æŸ¥</div>
                        </div>
                    </div>
                    <button @click="checkUpdate(true)" class="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-full hover:bg-purple-50 hover:text-purple-500 transition-colors">æª¢æŸ¥æ›´æ–°</button>
                </div>
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                     <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500">ğŸ“–</div>
                        <div class="font-bold text-sm text-slate-700">æ›´æ–°æ—¥èªŒ</div>
                    </div>
                    <button @click="showChangelog" class="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-full hover:bg-orange-50 hover:text-orange-500 transition-colors">æŸ¥çœ‹</button>
                </div>
                
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center mt-2">
                    <div class="text-[10px] text-slate-400 mb-1">ç¶²ç«™å•é¡Œå›å ±è«‹è¯ç¹«ç®¡ç†å“¡</div>
                    <div class="text-sm font-black text-slate-700">ç‹å²¦æ©</div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 text-center text-[9px] text-slate-300 font-bold tracking-widest uppercase bg-slate-50/50">
                é¹¿ğŸ¦ŒQAç¶²ç«™
            </div>
        </div>
    </div>

    <div id="shareCardTemplate" style="display: none;" class="fixed top-0 left-0 w-[600px] h-[900px] flex-col items-center justify-center bg-slate-900 text-white p-12">
         <div class="absolute inset-0 bg-gradient-to-br from-pink-500 to-purple-900 opacity-20"></div>
         <div class="relative z-10 bg-white/95 backdrop-blur-xl text-slate-900 p-12 rounded-[3rem] shadow-2xl w-full text-center border-8 border-white/20">
             <img src="./images/basic/icon.png" class="w-24 h-24 rounded-[2rem] mx-auto mb-8 shadow-2xl border-4 border-white">
             <div class="inline-block px-4 py-1.5 rounded-full bg-pink-100 text-pink-600 text-sm font-black mb-6 tracking-widest">é¹¿ğŸ¦ŒQAç¶²ç«™</div>
             <h2 id="scQ" class="text-3xl font-black mb-8 leading-snug"></h2>
             <div class="w-20 h-1.5 bg-slate-100 rounded-full mx-auto mb-8"></div>
             <p id="scA" class="text-2xl font-bold text-slate-600 leading-relaxed"></p>
         </div>
    </div>

    <div id="idCardTemplate" style="display: none;" class="fixed top-0 left-0 w-[600px] h-[960px] flex-col justify-between font-sans text-white bg-slate-900 relative overflow-hidden">
        <img :src="selectedBg" class="absolute inset-0 w-full h-full object-cover opacity-80" crossorigin="anonymous">
        <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/90"></div>
        <div class="relative z-20 p-12 pt-16">
             <div class="flex items-center gap-6">
                 <img src="./images/basic/icon.png" class="w-24 h-24 rounded-full border-4 border-white/50 shadow-2xl">
                 <div>
                     <div class="text-sm font-black tracking-[0.4em] opacity-70 mb-2">OFFICIAL FAN</div>
                     <div class="text-4xl font-black tracking-widest drop-shadow-lg">éº‹é¹¿èªè­‰</div>
                 </div>
             </div>
        </div>
        <div class="relative z-20 p-12 pb-20">
            <div class="mb-12">
                <div class="text-xs font-bold tracking-[0.3em] opacity-60 mb-2 uppercase border-b border-white/30 pb-3 inline-block">ç²‰çµ²æš±ç¨±</div>
                <div class="text-7xl font-black tracking-tight drop-shadow-2xl" x-text="idCardName"></div>
            </div>
            <div class="flex justify-between items-end">
                <div>
                    <div class="text-xs font-bold tracking-[0.3em] opacity-60 mb-1">èªè­‰ç·¨è™Ÿ</div>
                    <div class="text-4xl font-mono font-bold tracking-widest text-pink-300" x-text="generatedIdNumber"></div>
                </div>
                <div class="text-right">
                    <div class="text-xs font-bold tracking-[0.3em] opacity-60 mb-1">èªè­‰æ—¥æœŸ</div>
                    <div class="text-2xl font-mono opacity-90" x-text="new Date().toLocaleDateString()"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="examPaperTemplate" style="display: none;" class="fixed top-0 left-0 w-[800px] h-[600px] flex-col justify-center items-center font-sans text-slate-800 bg-[#fffbf0] relative overflow-hidden p-10 border-[20px] border-double border-[#d4af37]">
        <img :src="selectedQuizBg" class="absolute inset-0 w-full h-full object-cover opacity-30" crossorigin="anonymous">
        <div class="absolute inset-0 bg-white/80"></div>
        
        <div class="absolute top-0 left-0 w-32 h-32 border-t-[10px] border-l-[10px] border-[#d4af37] z-10"></div>
        <div class="absolute top-0 right-0 w-32 h-32 border-t-[10px] border-r-[10px] border-[#d4af37] z-10"></div>
        <div class="absolute bottom-0 left-0 w-32 h-32 border-b-[10px] border-l-[10px] border-[#d4af37] z-10"></div>
        <div class="absolute bottom-0 right-0 w-32 h-32 border-b-[10px] border-r-[10px] border-[#d4af37] z-10"></div>
        
        <div class="text-center z-20 relative">
            <div class="text-5xl font-black tracking-[0.5em] text-[#d4af37] mb-8 drop-shadow-md">æˆç¸¾è­‰æ˜</div>
            <div class="text-2xl font-bold text-slate-500 mb-6">èŒ²è­‰æ˜</div>
            <div class="text-6xl font-black text-slate-900 mb-6 underline decoration-4 decoration-pink-300 underline-offset-8" x-text="quizTakerName"></div>
            <div class="text-2xl font-bold text-slate-500 mb-8">åƒåŠ ã€Œéº‹é¹¿å¤§æœƒè€ƒã€ç²å¾—</div>
            <div class="flex justify-center items-center gap-4 mb-10">
                <span class="text-8xl font-black text-pink-500 drop-shadow-xl" x-text="quizScore * 20"></span>
                <span class="text-4xl font-bold text-slate-400 self-end mb-4">åˆ†</span>
            </div>
            <div class="inline-block px-8 py-3 bg-[#d4af37] text-white text-xl font-bold rounded-full tracking-widest shadow-lg">
                <span x-text="quizScore === 5 ? 'ğŸ† è¶…ç´šéµç²‰' : (quizScore >= 3 ? 'ğŸ¥ˆ è³‡æ·±éº‹é¹¿' : 'ğŸ¥‰ åŠªåŠ›åŠ æ²¹')"></span>
            </div>
        </div>
        <div class="absolute bottom-8 right-12 text-right z-20">
            <div class="text-sm font-bold text-slate-400 tracking-widest mb-1">èªè­‰å–®ä½</div>
            <div class="text-xl font-black text-slate-700">é¹¿ğŸ¦ŒQAç¶²ç«™</div>
            <div class="text-sm font-mono text-slate-400 mt-2" x-text="new Date().toLocaleDateString()"></div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type = 'success') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'click') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            } else if (type === 'success') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            }
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function deerApp() {
            return {
                appVersion: '3.1.2',
                isLoading: true,
                isProcessing: false,
                loadProgress: 0,
                currentTab: 'home',
                scrollY: 0,
                search: '',
                qaData: [],
                currentPage: 1,
                itemsPerPage: 20,
                flippedCards: [],
                chatInput: '',
                chatHistory: [{ id: 1, text: "å—¨ï¼æˆ‘æ˜¯ AI éº‹é¹¿ ğŸ¦Œ\næœ‰ä»€éº¼é—œæ–¼ä¸»æ’­çš„å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼", isUser: false, accuracy: 100 }],
                isTyping: false,
                quizStarted: false,
                quizTakerName: '',
                currentQuizIndex: 0,
                currentQuestion: null,
                currentOptions: [],
                hasAnswered: false,
                quizScore: 0,
                currentQuizSet: [],
                showBgSelectorModal: false, 
                selectedQuizBg: '', 
                idCardName: '',
                selectedBg: '',
                backgrounds: [],
                generatedIdNumber: 'D' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
                showSettingsModal: false,
                settings: { sound: true, itemsPerPage: 20 },
                modal: { isOpen: false, title: '', body: '', type: 'info' },
                tabs: [
                    {id: 'home', label: 'é¦–é ', icon: 'ğŸ '},
                    {id: 'ai', label: 'AI éº‹é¹¿', icon: 'ğŸ¤–'},
                    {id: 'quiz', label: 'å¤§æœƒè€ƒ', icon: 'ğŸ“'},
                    {id: 'idcard', label: 'èªè­‰', icon: 'ğŸªª'}
                ],
                synonyms: { "å¤šé«˜": "èº«é«˜", "å¤šé‡": "é«”é‡", "èƒ–": "é«”é‡", "ç˜¦": "é«”é‡", "å“ªè£¡äºº": "å®¶é„‰", "IG": "ç¤¾ç¾¤", "é–‹å°": "ç›´æ’­", "è³´": "Line" },
                deferredPrompt: null,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,

                async initApp() {
                    const savedSettings = localStorage.getItem('deer_settings');
                    if(savedSettings) this.settings = JSON.parse(savedSettings);

                    // PWA Prompt Capture
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.deferredPrompt = e;
                    });

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 10;
                        if(progress > 90) clearInterval(interval);
                        this.loadProgress = Math.min(progress, 90);
                    }, 150);

                    window.addEventListener('scroll', () => this.scrollY = window.scrollY);

                    this.loadDB();
                    await this.loadBackgrounds();
                    
                    clearInterval(interval);
                    this.loadProgress = 100;
                    setTimeout(() => { this.isLoading = false; }, 800);
                },

                playSound(type) { if(this.settings.sound) playTone(type); },
                
                toggleSound() { 
                    this.settings.sound = !this.settings.sound; 
                    this.saveSettings(); 
                    if(this.settings.sound) this.playSound('success'); 
                },

                saveSettings() {
                    localStorage.setItem('deer_settings', JSON.stringify(this.settings));
                    this.currentPage = 1; // reset page when items per page changes
                },
                
                loadDB() {
                    let rawData = window.deerQA_DB || [];
                    this.qaData = rawData.map((item, index) => ({ ...item, id: index + 1 }));
                    this.fuseInstance = new Fuse(this.qaData, { includeScore: true, threshold: 0.35, keys: ['tags', 'q', 'a'] });
                },

                async loadBackgrounds() {
                    const validBgs = [];
                    for(let i = 1; i <= 20; i++) {
                        const path = `./images/backgrounds/bg${i}.jpg`;
                        const exists = await new Promise(r => { const img = new Image(); img.onload = () => r(true); img.onerror = () => r(false); img.src = path; });
                        if(exists) validBgs.push(path);
                    }
                    this.backgrounds = validBgs.length ? validBgs : ['./images/basic/icon.png'];
                    this.selectedBg = this.backgrounds[0];
                    this.selectedQuizBg = this.backgrounds[0];
                },

                checkUpdate(manual) {
                    if(manual) {
                         fetch('./manifest.json?t=' + Date.now()).then(() => {
                             if(localStorage.getItem('deer_version') === this.appVersion) {
                                 this.showModal('æª¢æŸ¥çµæœ', 'ç›®å‰å·²ç¶“æ˜¯æœ€æ–°ç‰ˆæœ¬ (v' + this.appVersion + ')', 'update');
                             } else {
                                 this.showModal('ç™¼ç¾æ–°ç‰ˆæœ¬', 'è«‹é»æ“Šå¼·åˆ¶æ›´æ–°æŒ‰éˆ•ä»¥è¼‰å…¥æ–°å…§å®¹ã€‚', 'update');
                             }
                         }).catch(() => {
                             this.showModal('æª¢æŸ¥å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
                         });
                    }
                    localStorage.setItem('deer_version', this.appVersion);
                },

                forceUpdate() {
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            for(let registration of registrations) { registration.unregister(); }
                        });
                    }
                    caches.keys().then(keys => {
                         keys.forEach(key => caches.delete(key));
                    }).then(() => {
                         window.location.reload(true);
                    });
                },

                showChangelog() {
                    this.showSettingsModal = false;
                    this.showModal('æ›´æ–°æ—¥èªŒ v' + this.appVersion, 
                        'âœ¨ PWA å®‰è£åŠŸèƒ½æ”¯æ´ï¼\nâœ¨ å¯è‡ªè¨‚æ¯é é¡¯ç¤ºç­†æ•¸\nâœ¨ éŸ¿æ‡‰å¼ä½ˆå±€ï¼šè¢å¹•è¶Šå¤§é¡¯ç¤ºè¶Šå¤š QA\nâœ¨ å„ªåŒ– Loading ç•«é¢èˆ‡æ›´æ–°æª¢æŸ¥', 
                        'info');
                },

                async installPWA() {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        if (outcome === 'accepted') this.deferredPrompt = null;
                    } else {
                        if(this.isIOS) {
                            this.showModal('å®‰è£æ•™å­¸', 'è«‹é»æ“Š Safari ä¸‹æ–¹çš„åˆ†äº«æŒ‰éˆ• ğŸ“¤\nç„¶å¾Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ â•ã€å³å¯ï¼');
                        } else {
                            this.showModal('æç¤º', 'å¦‚æœæœªå‡ºç¾å®‰è£é¸é …ï¼Œè«‹é»æ“Šç€è¦½å™¨å³ä¸Šè§’é¸å–®ï¼Œé¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€ã€‚\n(æˆ–æ‚¨å·²å®‰è£é)');
                        }
                    }
                },

                shareApp() {
                    if (navigator.share) {
                        navigator.share({
                            title: 'é¹¿ğŸ¦ŒQAç¶²ç«™',
                            text: 'å¿«ä¾†çœ‹çœ‹é¹¿ä¸»æ’­çš„å°ˆå±¬ QA ç¶²ç«™ï¼',
                            url: window.location.href,
                        }).catch(console.error);
                    } else {
                        // Fallback copy to clipboard
                        navigator.clipboard.writeText(window.location.href).then(() => {
                             this.showModal('å·²è¤‡è£½', 'ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                        });
                    }
                },

                showModal(title, body, type = 'info') { this.modal = { isOpen: true, title, body, type }; },
                closeModal() { this.modal.isOpen = false; },
                openSettings() { this.showSettingsModal = true; this.playSound('click'); },
                changeTab(id) { this.currentTab = id; window.scrollTo({top:0, behavior:'smooth'}); },
                
                get paginatedData() {
                    let data = this.qaData;
                    if(this.search) data = this.fuseInstance.search(this.processQuery(this.search)).map(r => r.item);
                    const start = (this.currentPage - 1) * parseInt(this.settings.itemsPerPage);
                    return data.slice(start, start + parseInt(this.settings.itemsPerPage));
                },
                get totalPages() { return Math.ceil((this.search ? this.fuseInstance.search(this.processQuery(this.search)).length : this.qaData.length) / parseInt(this.settings.itemsPerPage)); },
                
                processQuery(input) { let processed = input; for (const [k, v] of Object.entries(this.synonyms)) if (input.includes(k)) processed += " " + v; return processed; },
                handleSearch() { this.currentPage = 1; },
                prevPage() { if(this.currentPage > 1) { this.currentPage--; window.scrollTo({top:0}); this.playSound('click'); } },
                nextPage() { if(this.currentPage < this.totalPages) { this.currentPage++; window.scrollTo({top:0}); this.playSound('click'); } },
                toggleCard(id) { if(this.flippedCards.includes(id)) this.flippedCards = this.flippedCards.filter(cid => cid !== id); else this.flippedCards.push(id); this.playSound('click'); },
                
                handleChatEnter(e) { if (e.isComposing || e.keyCode === 229) return; this.sendMessage(); },
                sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const text = this.chatInput;
                    this.chatInput = '';
                    this.chatHistory.push({id: Date.now(), text, isUser: true});
                    this.isTyping = true;
                    this.playSound('click');
                    setTimeout(() => document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight, 10);
                    setTimeout(() => {
                        let reply = "æŠ±æ­‰ï¼Œæˆ‘å¥½åƒæ²’è½æ‡‚...ğŸ¤”";
                        let acc = 0;
                        const results = this.fuseInstance.search(this.processQuery(text));
                        if(results.length > 0) {
                            const best = results[0];
                            acc = Math.round((1 - best.score) * 100);
                            reply = acc > 40 ? best.item.a : `ä¸å¤ªç¢ºå®šï¼Œä½ æ˜¯æƒ³å•ã€Œ${best.item.q}ã€å—ï¼Ÿ\n${best.item.a}`;
                        }
                        this.isTyping = false;
                        this.chatHistory.push({id: Date.now()+1, text: reply, isUser: false, accuracy: acc});
                        this.playSound('success');
                        this.$nextTick(() => document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight);
                    }, 800);
                },
                openMsgDetail(msg) { this.showModal('AI åˆ†æ', `åŸå§‹å•é¡ŒåŒ¹é…ä¿¡å¿ƒåº¦ï¼š${msg.accuracy}%`, 'info'); this.playSound('click'); },

                startQuiz() {
                    if(!this.quizTakerName) return this.showModal('æç¤º', 'è«‹å…ˆè¼¸å…¥åå­—ï¼');
                    let allQ = window.deerQuiz_DB || [];
                    if(allQ.length < 5) return this.showModal('éŒ¯èª¤', 'é¡Œåº«ä¸è¶³');
                    let shuffled = [...allQ].sort(() => 0.5 - Math.random());
                    this.currentQuizSet = shuffled.slice(0, 5);
                    this.quizStarted = true;
                    this.quizScore = 0;
                    this.currentQuizIndex = 0;
                    this.playSound('success');
                    this.loadQuestion();
                },
                loadQuestion() { this.hasAnswered = false; this.selectedOption = null; this.currentQuestion = this.currentQuizSet[this.currentQuizIndex]; this.currentOptions = [...this.currentQuestion.options].sort(() => 0.5 - Math.random()); },
                checkAnswer(opt) {
                    if(this.hasAnswered) return;
                    this.hasAnswered = true;
                    this.selectedOption = opt;
                    if(opt === this.currentQuestion.a) { this.quizScore++; confetti({ origin: { y: 0.7 } }); this.playSound('success'); } else { this.playSound('click'); }
                },
                nextQuestion() {
                    this.playSound('click');
                    if(this.currentQuizIndex < this.currentQuizSet.length - 1) {
                        this.currentQuizIndex++;
                        this.loadQuestion();
                    } else {
                        this.quizStarted = false;
                        this.showBgSelectorModal = true;
                    }
                },
                
                async confirmExamImage(bgUrl) {
                    this.selectedQuizBg = bgUrl;
                    this.showBgSelectorModal = false;
                    this.isProcessing = true;
                    setTimeout(async () => {
                        await this.captureElement('examPaperTemplate', 'certificate');
                        this.isProcessing = false;
                    }, 500);
                },

                async generateIDCard() {
                    if(!this.idCardName) return this.showModal('æç¤º', 'è«‹è¼¸å…¥æš±ç¨±');
                    this.isProcessing = true;
                    this.playSound('click');
                    setTimeout(async () => { await this.captureElement('idCardTemplate', 'share'); this.isProcessing = false; }, 100);
                },

                async openShareModal(item) {
                    document.getElementById('scQ').innerText = item.q;
                    document.getElementById('scA').innerText = item.a;
                    this.isProcessing = true;
                    this.playSound('click');
                    setTimeout(async () => { await this.captureElement('shareCardTemplate', 'share'); this.isProcessing = false; }, 100);
                },

                async captureElement(id, type) {
                    const el = document.getElementById(id);
                    el.style.display = 'flex';
                    try {
                        const canvas = await html2canvas(el, { scale: 2, useCORS: true, allowTaint: true });
                        const img = canvas.toDataURL("image/png");
                        this.modal.type = type;
                        const title = type === 'certificate' ? 'æ­å–œç²å¾—æˆç¸¾è­‰æ˜' : 'ç”ŸæˆæˆåŠŸ';
                        this.showModal(title, 'é•·æŒ‰ä¸‹æ–¹åœ–ç‰‡å³å¯å„²å­˜', type);
                        this.$nextTick(() => { document.getElementById('shareResult').innerHTML = `<img src="${img}" class="w-full h-auto">`; });
                        this.playSound('success');
                    } catch(e) { this.showModal('éŒ¯èª¤', 'åœ–ç‰‡ç”Ÿæˆå¤±æ•—'); } finally { el.style.display = 'none'; }
                }
            }
        }
    </script>
</body>
</html>