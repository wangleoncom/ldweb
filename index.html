<!DOCTYPE html>
<html lang="zh-TW" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¹¿ QA ç²‰çµ²ç«™</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./images/basic/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="./images/basic/icon.png">
    <meta name="theme-color" content="#fdf2f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é¹¿ QA">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Rounded+Mplus+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="./deer_db.js"></script>
    <script src="./quiz_db.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }
        
        console.log = function() {};
        console.warn = function() {};
        console.error = function() {};

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Rounded Mplus 1c"', '"Noto Sans TC"', 'sans-serif'] },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 10s infinite',
                        'spin-slow': 'spin 8s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'popup': 'popup 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    colors: { glass: { 100: 'rgba(255, 255, 255, 0.25)', 200: 'rgba(255, 255, 255, 0.45)' } },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0) rotate(0deg)' }, '50%': { transform: 'translateY(-15px) rotate(1deg)' } },
                        blob: { "0%": { transform: "translate(0px, 0px) scale(1)" }, "33%": { transform: "translate(30px, -50px) scale(1.1)" }, "66%": { transform: "translate(-20px, 20px) scale(0.9)" }, "100%": { transform: "translate(0px, 0px) scale(1)" } },
                        popup: { "0%": { transform: "scale(0.8) translateY(20px)", opacity: 0 }, "100%": { transform: "scale(1) translateY(0)", opacity: 1 } },
                        slideUp: { "0%": { transform: "translateY(40px)", opacity: 0 }, "100%": { transform: "translateY(0)", opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Rounded Mplus 1c', sans-serif; background-color: #fdf2f8; overflow-x: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
        .liquid-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background: radial-gradient(circle at 50% 50%, #fff0f5 0%, #f3e8ff 100%); }
        .liquid-blob { position: absolute; filter: blur(80px); opacity: 0.6; will-change: transform; }
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07); }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-top: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .appearance-none { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .off-screen-render { position: fixed; left: -9999px; top: 0; width: 600px; display: flex !important; visibility: visible !important; opacity: 1 !important; z-index: -1; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800 transition-colors duration-500 min-h-screen selection:bg-pink-200"
      x-data="deerApp()" x-init="initApp()">

    <div x-show="isLoading" 
         class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white/95 backdrop-blur-3xl transition-opacity duration-700"
         x-transition:leave="opacity-0 pointer-events-none">
        <div class="relative w-32 h-32 mb-8 flex items-center justify-center">
            <div class="absolute inset-0 rounded-full border-[6px] border-pink-100 animate-ping"></div>
            <div class="absolute inset-0 rounded-full border-[6px] border-t-pink-500 border-r-purple-400 border-b-transparent border-l-transparent animate-spin"></div>
            <img src="./images/basic/icon.png" class="relative z-10 w-24 h-24 rounded-full object-cover shadow-lg">
        </div>
        <div class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-600 tracking-wider mb-3">é¹¿ QA</div>
        <div class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase">ç³»çµ±è¼‰å…¥ä¸­</div>
        <div class="mt-8 w-48 h-1 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-pink-400 to-purple-500 transition-all duration-300" :style="`width: ${loadProgress}%`"></div>
        </div>
    </div>

    <div x-show="isProcessing" class="fixed inset-0 z-[9998] flex items-center justify-center bg-black/20 backdrop-blur-sm" x-cloak>
        <div class="bg-white/95 p-8 rounded-[2rem] shadow-2xl flex flex-col items-center animate-popup border border-white">
            <div class="w-12 h-12 border-[5px] border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <span class="text-sm font-bold text-slate-600 tracking-widest">AI é‹ç®—è™•ç†ä¸­</span>
        </div>
    </div>

    <div class="liquid-bg">
        <div class="liquid-blob bg-pink-200 w-[700px] h-[700px] rounded-full top-[-20%] left-[-20%] animate-blob mix-blend-multiply"></div>
        <div class="liquid-blob bg-purple-200 w-[600px] h-[600px] rounded-full top-[30%] right-[-15%] animate-blob animation-delay-2000 mix-blend-multiply"></div>
        <div class="liquid-blob bg-blue-100 w-[500px] h-[500px] rounded-full bottom-[-10%] left-[10%] animate-blob animation-delay-4000 mix-blend-multiply"></div>
    </div>

    <nav class="fixed top-0 w-full z-40 transition-all duration-500" :class="scrollY > 10 ? 'glass-nav py-3' : 'bg-transparent py-5'">
        <div class="max-w-[95%] w-full mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer group" @click="handleTitleClick">
                <div class="relative">
                     <img src="./images/basic/icon.png" class="w-11 h-11 rounded-full border-[3px] border-white shadow-md object-cover transition-transform group-hover:scale-110 group-active:scale-95">
                     <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-400 rounded-full border-[3px] border-white animate-pulse-fast"></div>
                </div>
                <div class="flex flex-col">
                    <span class="font-black text-xl text-slate-800 tracking-tight leading-none transition-colors">é¹¿ QA</span>
                    <span class="text-[10px] font-bold text-slate-400 tracking-widest mt-0.5">å®˜æ–¹ç²‰çµ²è‡ªè£½</span>
                </div>
            </div>
            <button @click="openSettings" class="w-10 h-10 rounded-full bg-white/60 hover:bg-white flex items-center justify-center transition-all shadow-sm hover:shadow-md active:scale-90 border border-white">
                <svg class="w-5 h-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
        </div>
    </nav>

    <main class="pt-28 px-4 pb-32 w-full mx-auto min-h-screen max-w-7xl">
        
        <div x-show="currentTab === 'home'" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-y-10" x-transition:enter-end="opacity-100 translate-y-0">
            
            <div class="glass-panel rounded-[2.5rem] p-6 mb-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-48 h-48 bg-gradient-to-bl from-pink-300/40 to-transparent rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                <div class="flex flex-col items-center text-center relative z-10">
                    <div class="mb-2 text-xs font-bold text-pink-500 tracking-widest uppercase bg-pink-50 px-3 py-1 rounded-full border border-pink-100">ç”Ÿæ—¥å€’æ•¸</div>
                    <div class="flex items-end gap-1 mb-1">
                        <span class="text-4xl font-black text-slate-800 tabular-nums" x-text="countdownDays"></span>
                        <span class="text-sm font-bold text-slate-400 mb-1.5">å¤©</span>
                    </div>
                    <div class="text-[10px] text-slate-400 font-bold">è·é›¢ 10æœˆ3æ—¥ é¹¿é¹¿ç”Ÿæ—¥</div>
                </div>
            </div>

            <div class="glass-panel rounded-[2.5rem] p-6 mb-8 relative overflow-hidden group">
                <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                    <div class="relative group-hover:scale-105 transition-transform duration-500 cursor-pointer" @click="playSound('success')">
                        <img src="./images/basic/icon.png" class="w-24 h-24 rounded-[2rem] shadow-2xl object-cover border-[4px] border-white">
                    </div>
                    <div class="text-center md:text-left flex-1">
                        <h2 class="text-2xl font-black text-slate-800 mb-2">é¹¿ <span class="text-pink-500">ğŸ¦Œ</span></h2>
                        <p class="text-slate-500 font-medium mb-4 text-xs leading-relaxed">
                            å¤©ç§¤åº§ï½œ170cmï½œ42kg<br>
                            æ”¶éŒ„æ‰€æœ‰é—œæ–¼é¹¿çš„å°ç§˜å¯†èˆ‡ç›´æ’­å¸¸è¦‹å•é¡Œã€‚
                        </p>
                        <div class="flex justify-center md:justify-start gap-2">
                            <a href="https://www.tiktok.com/@ld.1003_" target="_blank" class="px-5 py-2.5 bg-black text-white rounded-full flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-slate-200">
                                <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                                <span class="font-bold text-[10px]">TikTok</span>
                            </a>
                            <a href="https://www.instagram.com/ld.1003_/" target="_blank" class="px-5 py-2.5 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-600 text-white rounded-full flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-pink-100">
                                <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg>
                                <span class="font-bold text-[10px]">IG</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative mb-6 z-20">
                <input type="text" x-model.debounce.300ms="search" @input="handleSearch" placeholder="æœå°‹é—œæ–¼é¹¿çš„å•é¡Œ..." 
                       class="w-full pl-12 pr-6 py-4 rounded-2xl bg-white/70 border-2 border-transparent focus:border-pink-300 focus:bg-white focus:ring-4 focus:ring-pink-100/50 shadow-sm outline-none transition-all text-sm font-bold placeholder-slate-400 text-slate-800 backdrop-blur-md">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>

            <div class="grid gap-4 pb-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                <template x-for="item in paginatedData" :key="item.id">
                    <div class="group h-48 perspective-1000 cursor-pointer" @click="toggleCard(item.id)">
                        <div class="relative w-full h-full transform-style-3d transition-transform duration-700 shadow-sm hover:shadow-xl rounded-[2rem]" :class="{ 'rotate-y-180': flippedCards.includes(item.id) }">
                            <div class="absolute w-full h-full glass-panel rounded-[2rem] p-6 flex flex-col justify-between backface-hidden bg-white/70">
                                <div>
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-pink-100 text-pink-600 text-[10px] font-black shadow-inner">Q</span>
                                        <span class="text-[9px] font-bold text-slate-300 bg-white px-2 py-1 rounded-full">#<span x-text="item.id"></span></span>
                                    </div>
                                    <h3 class="text-base font-bold text-slate-800 leading-snug line-clamp-3" x-text="item.q"></h3>
                                </div>
                                <div class="text-right text-[9px] font-bold text-slate-400 uppercase tracking-widest opacity-60">é»æ“ŠæŸ¥çœ‹</div>
                            </div>
                            <div class="absolute w-full h-full glass-panel rounded-[2rem] p-5 flex flex-col justify-between items-center backface-hidden rotate-y-180 bg-white/95 border-2 border-pink-100">
                                <div class="w-full h-full overflow-y-auto custom-scrollbar flex items-center justify-center">
                                    <p class="text-sm font-bold text-center text-slate-700 leading-relaxed" x-text="item.a"></p>
                                </div>
                                <button @click.stop="openShareModal(item)" class="mt-2 w-full py-2 bg-slate-50 rounded-xl text-[10px] font-bold text-slate-400 hover:bg-pink-50 hover:text-pink-600 transition-colors">
                                    åˆ†äº«å¡ç‰‡
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="flex justify-center items-center gap-3 pb-8 mt-2">
                <button @click="prevPage" :disabled="currentPage === 1" class="w-10 h-10 rounded-2xl bg-white/50 flex items-center justify-center disabled:opacity-30 hover:bg-white text-slate-600 shadow-sm transition-all"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg></button>
                <div class="px-4 py-2 bg-white/50 rounded-2xl font-bold text-slate-500 shadow-sm text-xs tracking-widest"><span x-text="currentPage"></span> / <span x-text="totalPages"></span></div>
                <button @click="nextPage" :disabled="currentPage === totalPages" class="w-10 h-10 rounded-2xl bg-white/50 flex items-center justify-center disabled:opacity-30 hover:bg-white text-slate-600 shadow-sm transition-all"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg></button>
            </div>
        </div>

        <div x-show="currentTab === 'ai'" x-cloak class="h-[75vh] flex flex-col glass-panel rounded-[2.5rem] overflow-hidden shadow-2xl relative bg-white/60 border-white/60"
             x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            <div class="bg-white/80 backdrop-blur-xl p-4 border-b border-white flex items-center gap-3 z-10 shadow-sm">
                <img src="./images/basic/AI.png" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                <div class="flex-1">
                    <h3 class="font-black text-slate-800 text-sm flex items-center gap-2">AI éº‹é¹¿ <span class="text-[9px] bg-green-100 text-green-600 px-1.5 rounded-full">Online</span></h3>
                    <div class="text-[9px] font-bold text-slate-400">æ™ºæ…§å°è©±ãƒ»ç²¾æº–æ‡‰ç­”</div>
                </div>
            </div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth custom-scrollbar">
                <template x-for="msg in chatHistory" :key="msg.id">
                    <div class="flex w-full animate-slide-up" :class="msg.isUser ? 'justify-end' : 'justify-start'">
                        <div class="max-w-[85%] px-5 py-3.5 rounded-2xl shadow-sm text-sm leading-relaxed font-medium transition-all"
                             @click="!msg.isUser && openMsgDetail(msg)"
                             :class="msg.isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-white text-slate-700 rounded-bl-none border border-white hover:shadow-md cursor-pointer'">
                            <p x-text="msg.text" class="whitespace-pre-line"></p>
                        </div>
                    </div>
                </template>
                <div x-show="isTyping" class="flex justify-start animate-pulse"><div class="bg-white px-4 py-3 rounded-2xl rounded-bl-none flex gap-1.5 shadow-sm border border-white"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></div></div></div>
            </div>
            <div class="p-3 bg-white/80 backdrop-blur-xl border-t border-white z-10">
                <div class="relative flex items-center gap-2">
                    <input type="text" x-model="chatInput" @keydown.enter="handleChatEnter" placeholder="è¼¸å…¥å•é¡Œ... (ä¾‹å¦‚ï¼šèº«é«˜ã€ç”Ÿæ—¥)" class="flex-1 pl-5 pr-12 py-3.5 rounded-full bg-slate-100 border-2 border-transparent focus:border-pink-300 focus:bg-white outline-none text-slate-800 shadow-inner text-sm font-bold transition-all">
                    <button @click="sendMessage" class="absolute right-1.5 p-2 bg-slate-800 text-white rounded-full shadow-lg hover:bg-pink-500 transition-all active:scale-90" :disabled="!chatInput.trim()">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'quiz'" x-cloak class="max-w-xl mx-auto" x-transition:enter="transition ease-out duration-500">
            <div x-show="!quizStarted" class="glass-panel rounded-[3rem] p-10 text-center relative overflow-hidden bg-white/70">
                <div class="relative z-10">
                    <div class="text-6xl mb-6 animate-float">ğŸ“</div>
                    <h2 class="text-2xl font-black text-slate-800 mb-2">éº‹é¹¿å¤§æœƒè€ƒ</h2>
                    <p class="text-slate-500 mb-8 font-bold text-xs tracking-wide">è­‰æ˜ä½ æ˜¯éµç²‰çš„æ™‚åˆ»åˆ°äº†</p>
                    <input type="text" x-model="quizTakerName" placeholder="è¼¸å…¥ä½ çš„åå­—" class="w-full max-w-[200px] mx-auto mb-6 px-6 py-3 rounded-2xl bg-white border-2 border-pink-100 focus:border-pink-400 outline-none text-center font-bold shadow-sm transition-all text-sm">
                    <button @click="startQuiz" class="w-full max-w-[200px] px-8 py-3 bg-slate-800 text-white rounded-2xl font-bold shadow-lg shadow-slate-200 hover:shadow-xl hover:scale-105 transition-all active:scale-95 text-sm">é–‹å§‹æŒ‘æˆ°</button>
                </div>
            </div>
            <div x-show="quizStarted" class="glass-panel rounded-[2.5rem] p-8 shadow-xl bg-white/80 border-white">
                <div class="flex justify-between items-center mb-6">
                    <span class="bg-slate-800 text-white px-3 py-1 rounded-lg text-[10px] font-black tracking-widest">Q.<span x-text="currentQuizIndex + 1"></span></span>
                    <div class="h-1.5 flex-1 mx-4 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-pink-500 to-purple-500 transition-all duration-500 rounded-full" :style="`width: ${((currentQuizIndex + 1) / currentQuizSet.length) * 100}%`"></div>
                    </div>
                </div>
                <h3 class="text-lg font-black text-slate-800 mb-8 min-h-[60px] flex items-center justify-center text-center leading-relaxed" x-text="currentQuestion?.q"></h3>
                <div class="grid gap-3">
                    <template x-for="(opt, idx) in currentOptions" :key="idx">
                        <button @click="checkAnswer(opt)" :disabled="hasAnswered"
                                class="w-full p-4 rounded-2xl text-left font-bold transition-all border-2 flex items-center relative overflow-hidden group active:scale-98"
                                :class="hasAnswered ? (opt === currentQuestion.a ? 'bg-green-50 border-green-400 text-green-700' : (selectedOption === opt ? 'bg-red-50 border-red-400 text-red-700' : 'bg-white border-transparent opacity-40')) : 'bg-white border-transparent hover:border-pink-300 hover:bg-pink-50 text-slate-700 shadow-sm'">
                            <span class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] mr-3 font-black text-slate-500 group-hover:bg-white" x-text="['A','B','C','D'][idx]"></span>
                            <span class="text-sm" x-text="opt"></span>
                        </button>
                    </template>
                </div>
                <button x-show="hasAnswered" @click="nextQuestion" class="mt-6 w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-slate-700 transition-all animate-slide-up active:scale-95 text-sm">
                    <span x-text="currentQuizIndex === currentQuizSet.length - 1 ? 'å®Œæˆæ¸¬é©—' : 'ä¸‹ä¸€é¡Œ'"></span>
                </button>
            </div>
        </div>

        <div x-show="currentTab === 'idcard'" x-cloak class="glass-panel rounded-[3rem] p-8 shadow-xl text-center max-w-sm mx-auto bg-white/70">
            <h2 class="text-2xl font-black mb-1 text-slate-800">éº‹é¹¿èªè­‰</h2>
            <p class="text-slate-500 text-[10px] mb-6 font-bold tracking-widest uppercase">ç”Ÿæˆå°ˆå±¬ç²‰çµ²è­‰æ˜</p>
            <div class="space-y-5 mb-8 text-left">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider pl-2">æš±ç¨±</label>
                    <input type="text" x-model="idCardName" placeholder="è¼¸å…¥åå­—..." class="w-full px-5 py-3 rounded-2xl bg-white border-2 border-transparent focus:border-pink-300 outline-none font-bold shadow-sm transition-all text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-wider pl-2">æ¨£å¼é¸æ“‡</label>
                    <div class="grid grid-cols-2 gap-3">
                         <div @click="selectedBg = './images/backgrounds/bg16.jpg'; playSound('click')" 
                              class="aspect-[3/4] rounded-2xl overflow-hidden cursor-pointer border-[3px] transition-all relative"
                              :class="selectedBg === './images/backgrounds/bg16.jpg' ? 'border-pink-500 ring-2 ring-pink-200' : 'border-white opacity-70 grayscale'">
                            <img src="./images/backgrounds/bg16.jpg" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-[3/4] rounded-2xl bg-slate-100 flex items-center justify-center border-[3px] border-white">
                            <span class="text-[10px] font-bold text-slate-400">æ›´å¤šæ¨£å¼<br>æ•¬è«‹æœŸå¾…</span>
                        </div>
                    </div>
                </div>
            </div>
            <button @click="generateIDCard" class="w-full py-3.5 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-2xl font-bold shadow-lg shadow-pink-200 hover:shadow-xl hover:-translate-y-1 transition-all active:scale-95 text-sm tracking-wide">ç«‹å³ç”Ÿæˆ</button>
        </div>
    </main>

    <div class="fixed bottom-8 left-0 right-0 z-50 px-6 pointer-events-none safe-area-bottom">
        <nav class="pointer-events-auto flex items-center justify-between p-2 rounded-[2.5rem] glass-nav shadow-2xl max-w-[320px] mx-auto border border-white/60">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="changeTab(tab.id); playSound('click')"
                        class="relative w-full py-3.5 rounded-[2rem] flex flex-col items-center justify-center gap-1 transition-all duration-300 group">
                    <span class="text-xl transition-transform duration-300 group-active:scale-90" :class="currentTab === tab.id ? '-translate-y-1' : 'grayscale opacity-50'" x-text="tab.icon"></span>
                    <span class="text-[9px] font-black transition-all duration-300 leading-none" :class="currentTab === tab.id ? 'text-slate-800 scale-100' : 'text-slate-400 scale-0 opacity-0 h-0'" x-text="tab.label"></span>
                    <div class="absolute bottom-1.5 w-1 h-1 rounded-full bg-pink-500 transition-all duration-300" :class="currentTab === tab.id ? 'opacity-100 scale-100' : 'opacity-0 scale-0'"></div>
                </button>
            </template>
        </nav>
    </div>

    <div x-show="modal.isOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-6" x-transition.opacity x-cloak>
        <div @click.outside="closeModal" class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl relative text-center border-4 border-white animate-popup">
            <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl shadow-inner" 
                 :class="modal.type === 'error' ? 'bg-red-50 text-red-500' : (modal.type === 'success' ? 'bg-green-50 text-green-500' : 'bg-slate-50 text-slate-500')">
                <span x-text="modal.type === 'error' ? 'âš ï¸' : (modal.type === 'success' ? 'âœ¨' : 'â„¹ï¸')"></span>
            </div>
            <h3 class="text-xl font-black text-slate-800 mb-2" x-text="modal.title"></h3>
            <div class="text-slate-500 font-bold text-sm mb-6 leading-relaxed whitespace-pre-line" x-text="modal.body"></div>
            
            <template x-if="modal.type === 'share' || modal.type === 'certificate'">
                <div id="shareResult" class="mb-6 rounded-2xl overflow-hidden shadow-lg border-4 border-slate-50 bg-slate-100 min-h-[200px]"></div>
            </template>
            
            <button @click="closeModal" class="w-full py-3.5 bg-slate-800 text-white rounded-2xl font-bold shadow-lg transition-all active:scale-95 text-sm">é—œé–‰</button>
        </div>
    </div>

    <div x-show="showSettingsModal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/40 backdrop-blur-sm p-6" x-transition.opacity x-cloak>
        <div @click.outside="showSettingsModal = false" class="bg-white/95 backdrop-blur-2xl rounded-[2.5rem] max-w-sm w-full shadow-2xl overflow-hidden animate-slide-up border border-white">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-black text-lg text-slate-800">ç³»çµ±è¨­å®š</h3>
                <button @click="showSettingsModal = false" class="w-8 h-8 rounded-full bg-slate-200/50 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition-colors">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                 <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500">ğŸµ</div>
                         <div class="font-bold text-sm text-slate-700">éŸ³æ•ˆé–‹é—œ</div>
                    </div>
                    <button @click="toggleSound" class="w-12 h-7 rounded-full transition-colors duration-300 relative px-1" :class="settings.sound ? 'bg-green-400' : 'bg-slate-200'">
                        <div class="w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-300" :class="settings.sound ? 'translate-x-5' : 'translate-x-0'"></div>
                    </button>
                </div>
                
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500">ğŸ“„</div>
                         <div><div class="font-bold text-sm text-slate-700">æ¯é é¡¯ç¤º</div></div>
                    </div>
                    <select x-model="settings.itemsPerPage" @change="saveSettings" class="bg-slate-100 text-xs font-bold rounded-lg py-1.5 px-3 outline-none border-transparent focus:ring-2 focus:ring-pink-200 text-slate-600 appearance-none">
                        <option value="10">10 ç­†</option>
                        <option value="20">20 ç­†</option>
                        <option value="50">50 ç­†</option>
                    </select>
                </div>

                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center mt-4">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">ç‰ˆæœ¬ v4.2.0</div>
                    <div class="text-xs font-black text-slate-700">å®˜æ–¹ç²‰çµ²è‡ªè£½</div>
                </div>
            </div>
        </div>
    </div>

    <div id="shareCardTemplate" class="off-screen-render flex-col items-center justify-center bg-slate-900 text-white p-16 w-[800px] h-[1000px]">
         <div class="absolute inset-0 bg-gradient-to-br from-pink-500 via-purple-600 to-indigo-900 opacity-90"></div>
         <div class="relative z-10 bg-white/95 backdrop-blur-xl text-slate-900 p-16 rounded-[4rem] shadow-2xl w-full text-center border-[12px] border-white/20 flex flex-col items-center justify-center h-full">
             <img src="./images/basic/icon.png" class="w-32 h-32 rounded-[2.5rem] mb-10 shadow-2xl border-4 border-white">
             <div class="inline-block px-6 py-2 rounded-full bg-pink-100 text-pink-600 text-lg font-black mb-8 tracking-widest">é¹¿ QA ç²‰çµ²ç«™</div>
             <h2 id="scQ" class="text-4xl font-black mb-10 leading-snug px-4"></h2>
             <div class="w-24 h-2 bg-slate-100 rounded-full mx-auto mb-10"></div>
             <p id="scA" class="text-3xl font-bold text-slate-600 leading-relaxed px-4"></p>
         </div>
    </div>

    <div id="idCardTemplate" class="off-screen-render flex-col justify-between font-sans text-white bg-slate-900 relative overflow-hidden w-[800px] h-[1200px]">
        <img src="./images/backgrounds/bg16.jpg" class="absolute inset-0 w-full h-full object-cover" crossorigin="anonymous">
        <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-black/90"></div>
        <div class="relative z-20 p-16 pt-20">
             <div class="flex items-center gap-8">
                 <img src="./images/basic/icon.png" class="w-32 h-32 rounded-full border-[6px] border-white/50 shadow-2xl">
                 <div>
                     <div class="text-lg font-black tracking-[0.4em] opacity-80 mb-2">OFFICIAL FAN</div>
                     <div class="text-6xl font-black tracking-widest drop-shadow-lg">éº‹é¹¿èªè­‰</div>
                 </div>
             </div>
        </div>
        <div class="relative z-20 p-16 pb-24">
            <div class="mb-16">
                <div class="text-xl font-bold tracking-[0.3em] opacity-70 mb-4 uppercase border-b-2 border-white/30 pb-4 inline-block">ç²‰çµ²æš±ç¨±</div>
                <div class="text-8xl font-black tracking-tight drop-shadow-2xl" x-text="idCardName"></div>
            </div>
            <div class="flex justify-between items-end">
                <div>
                    <div class="text-lg font-bold tracking-[0.3em] opacity-70 mb-2">èªè­‰ç·¨è™Ÿ</div>
                    <div class="text-5xl font-mono font-bold tracking-widest text-pink-300" x-text="generatedIdNumber"></div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold tracking-[0.3em] opacity-70 mb-2">èªè­‰æ—¥æœŸ</div>
                    <div class="text-3xl font-mono opacity-90" x-text="new Date().toLocaleDateString('zh-TW')"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="examPaperTemplate" class="off-screen-render flex-col justify-center items-center font-sans text-slate-800 bg-[#fffbf0] relative overflow-hidden p-16 border-[30px] border-double border-[#d4af37] w-[1000px] h-[750px]">
        <img src="./images/backgrounds/bg16.jpg" class="absolute inset-0 w-full h-full object-cover opacity-20" crossorigin="anonymous">
        <div class="absolute inset-0 bg-white/70"></div>
        <div class="text-center z-20 relative flex flex-col items-center justify-center h-full">
            <div class="text-6xl font-black tracking-[0.5em] text-[#d4af37] mb-10 drop-shadow-md">æˆç¸¾è­‰æ˜</div>
            <div class="text-3xl font-bold text-slate-500 mb-6">èŒ²è­‰æ˜</div>
            <div class="text-7xl font-black text-slate-900 mb-8 underline decoration-4 decoration-pink-300 underline-offset-8" x-text="quizTakerName"></div>
            <div class="text-3xl font-bold text-slate-500 mb-10">åƒåŠ ã€Œéº‹é¹¿å¤§æœƒè€ƒã€ç²å¾—</div>
            <div class="flex justify-center items-center gap-6 mb-12">
                <span class="text-[10rem] font-black text-pink-500 drop-shadow-xl" x-text="quizScore * 20"></span>
                <span class="text-5xl font-bold text-slate-400 self-end mb-6">åˆ†</span>
            </div>
            <div class="inline-block px-10 py-4 bg-[#d4af37] text-white text-2xl font-bold rounded-full tracking-widest shadow-lg">
                <span x-text="quizScore === 5 ? 'ğŸ† è¶…ç´šéµç²‰' : (quizScore >= 3 ? 'ğŸ¥ˆ è³‡æ·±éº‹é¹¿' : 'ğŸ¥‰ åŠªåŠ›åŠ æ²¹')"></span>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(type = 'success') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'click') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.02, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'success') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }

        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const app = document.querySelector('[x-data]').__x.$data;
            if(app && app.showModal) app.showModal('ç³»çµ±éŒ¯èª¤', `ä»£ç¢¼ï¼š${lineNo}\nè¨Šæ¯ï¼š${msg}`, 'error');
            return true;
        };

        window.onunhandledrejection = function(event) {
             const app = document.querySelector('[x-data]').__x.$data;
             if(app && app.showModal) app.showModal('é€£ç·šéŒ¯èª¤', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚', 'error');
        };

        function deerApp() {
            return {
                appVersion: '4.2.0',
                isLoading: true,
                isProcessing: false,
                loadProgress: 0,
                currentTab: 'home',
                scrollY: 0,
                search: '',
                qaData: [],
                currentPage: 1,
                itemsPerPage: 20,
                flippedCards: [],
                chatInput: '',
                chatHistory: [{ id: 1, text: "å—¨ï¼æˆ‘æ˜¯ AI éº‹é¹¿ ğŸ¦Œ\næˆ‘å·²ç¶“å‡ç´šäº†ï¼å•æˆ‘é—œæ–¼ä¸»æ’­çš„ä»»ä½•å•é¡Œå§ï¼", isUser: false, accuracy: 100 }],
                isTyping: false,
                quizStarted: false,
                quizTakerName: '',
                currentQuizIndex: 0,
                currentQuestion: null,
                currentOptions: [],
                hasAnswered: false,
                quizScore: 0,
                currentQuizSet: [],
                selectedQuizBg: '', 
                idCardName: '',
                selectedBg: './images/backgrounds/bg16.jpg',
                generatedIdNumber: 'D' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
                showSettingsModal: false,
                settings: { sound: true, itemsPerPage: 20 },
                modal: { isOpen: false, title: '', body: '', type: 'info' },
                easterEggCount: 0,
                countdownDays: 0,
                tabs: [
                    {id: 'home', label: 'é¦–é ', icon: 'ğŸ '},
                    {id: 'ai', label: 'AI éº‹é¹¿', icon: 'ğŸ¤–'},
                    {id: 'quiz', label: 'å¤§æœƒè€ƒ', icon: 'ğŸ“'},
                    {id: 'idcard', label: 'èªè­‰', icon: 'ğŸªª'}
                ],
                synonyms: {
                    "å¤šé«˜": "èº«é«˜", "å¤šé‡": "é«”é‡", "èƒ–": "é«”é‡", "ç˜¦": "é«”é‡", 
                    "å“ªè£¡äºº": "å®¶é„‰", "ä½å“ª": "å®¶é„‰", "IG": "ç¤¾ç¾¤", "é–‹å°": "ç›´æ’­", 
                    "è³´": "Line", "å¹¾æ­²": "å¹´ç´€", "ç”Ÿæ—¥": "å¹´ç´€", "å°è±¡": "ç”·æœ‹å‹",
                    "æ´—æ¾¡": "æ´—é ­", "ç”·å‹": "ç”·æœ‹å‹"
                },
                fallbackReplies: [
                    "é€™å€‹å•é¡Œè€ƒå€’éº‹é¹¿äº† ğŸ¦ŒğŸ’¦\næ›å€‹é—œéµå­—è©¦è©¦çœ‹ï¼Ÿ",
                    "æŠ±æ­‰ï¼Œæˆ‘ä¸å¤ªç¢ºå®šé€™å€‹å•é¡Œçš„ç­”æ¡ˆ ğŸ¤”",
                    "å—¯... é—œæ–¼é€™é»æˆ‘å¥½åƒé‚„æ²’å­¸åˆ° > <",
                    "ä½ å¯ä»¥è©¦è©¦çœ‹æœå°‹ã€Œèº«é«˜ã€ã€ã€Œç”Ÿæ—¥ã€æˆ–ã€Œç›´æ’­ã€å–”ï¼"
                ],
                greetings: ["å—¨", "ä½ å¥½", "å“ˆå›‰", "hello", "hi"],

                async initApp() {
                    this.calculateCountdown();
                    const savedSettings = localStorage.getItem('deer_settings');
                    if(savedSettings) this.settings = JSON.parse(savedSettings);

                    window.addEventListener('scroll', () => this.scrollY = window.scrollY);

                    this.loadDB();
                    
                    const preloadImage = new Image();
                    preloadImage.src = './images/backgrounds/bg16.jpg';

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 15;
                        if(progress > 95) clearInterval(interval);
                        this.loadProgress = Math.min(progress, 95);
                    }, 100);

                    setTimeout(() => { 
                        clearInterval(interval);
                        this.loadProgress = 100;
                        setTimeout(() => this.isLoading = false, 500);
                    }, 1500);
                },

                calculateCountdown() {
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    let target = new Date(currentYear, 9, 3); 
                    if (today > target) target = new Date(currentYear + 1, 9, 3);
                    const diff = target - today;
                    this.countdownDays = Math.ceil(diff / (1000 * 60 * 60 * 24));
                },

                handleTitleClick() {
                    this.easterEggCount++;
                    this.playSound('click');
                    if (this.easterEggCount === 5) {
                        this.showModal('å½©è›‹æç¤º', 'å†é» 5 ä¸‹è©¦è©¦çœ‹ï¼Ÿ', 'info');
                    }
                    if (this.easterEggCount >= 10) {
                        this.playSound('success');
                        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                        this.showModal('éš±è—å½©è›‹', 'ğŸ‰ æ­å–œç™¼ç¾éš±è—å½©è›‹ï¼', 'success');
                        this.easterEggCount = 0;
                    }
                },

                playSound(type) { if(this.settings.sound) playTone(type); },
                toggleSound() { this.settings.sound = !this.settings.sound; this.saveSettings(); if(this.settings.sound) this.playSound('success'); },
                saveSettings() { localStorage.setItem('deer_settings', JSON.stringify(this.settings)); this.currentPage = 1; },
                
                loadDB() {
                    let rawData = window.deerQA_DB || [];
                    this.qaData = rawData.map((item, index) => ({ ...item, id: index + 1 }));
                    this.fuseInstance = new Fuse(this.qaData, { 
                        includeScore: true, 
                        threshold: 0.35, 
                        ignoreLocation: true,
                        keys: [
                            { name: 'q', weight: 0.7 },
                            { name: 'tags', weight: 0.2 },
                            { name: 'a', weight: 0.1 }
                        ] 
                    });
                },

                showModal(title, body, type = 'info') { this.modal = { isOpen: true, title, body, type }; },
                closeModal() { this.modal.isOpen = false; },
                openSettings() { this.showSettingsModal = true; this.playSound('click'); },
                changeTab(id) { this.currentTab = id; window.scrollTo({top:0, behavior:'smooth'}); },
                
                get paginatedData() {
                    let data = this.qaData;
                    if(this.search) {
                         const processedSearch = this.preprocessInput(this.search);
                         data = this.fuseInstance.search(processedSearch).map(r => r.item);
                    }
                    const start = (this.currentPage - 1) * parseInt(this.settings.itemsPerPage);
                    return data.slice(start, start + parseInt(this.settings.itemsPerPage));
                },
                get totalPages() { 
                    const count = this.search ? this.fuseInstance.search(this.preprocessInput(this.search)).length : this.qaData.length;
                    return Math.ceil(count / parseInt(this.settings.itemsPerPage)); 
                },
                
                handleSearch() { this.currentPage = 1; },
                prevPage() { if(this.currentPage > 1) { this.currentPage--; window.scrollTo({top:0}); this.playSound('click'); } },
                nextPage() { if(this.currentPage < this.totalPages) { this.currentPage++; window.scrollTo({top:0}); this.playSound('click'); } },
                toggleCard(id) { if(this.flippedCards.includes(id)) this.flippedCards = this.flippedCards.filter(cid => cid !== id); else this.flippedCards.push(id); this.playSound('click'); },
                
                handleChatEnter(e) { if (e.isComposing || e.keyCode === 229) return; this.sendMessage(); },
                
                preprocessInput(input) {
                    let processed = input.toLowerCase();
                    for (const [key, value] of Object.entries(this.synonyms)) {
                        if (processed.includes(key)) processed += " " + value;
                    }
                    return processed;
                },

                sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const originalText = this.chatInput.trim();
                    this.chatInput = '';
                    this.chatHistory.push({id: Date.now(), text: originalText, isUser: true});
                    this.isTyping = true;
                    this.playSound('click');
                    
                    const scrollContainer = document.getElementById('chatContainer');
                    setTimeout(() => scrollContainer.scrollTop = scrollContainer.scrollHeight, 10);
                    
                    setTimeout(() => {
                        let reply = "";
                        let acc = 0;
                        
                        if (this.greetings.some(g => originalText.toLowerCase().includes(g))) {
                            reply = "å—¨ï¼æˆ‘æ˜¯ AI éº‹é¹¿ ğŸ¦Œ\nå¾ˆé«˜èˆˆè¦‹åˆ°ä½ ï¼æƒ³å•ä»€éº¼éƒ½å¯ä»¥å–”ï¼";
                            acc = 100;
                        } else {
                            const processedText = this.preprocessInput(originalText);
                            const results = this.fuseInstance.search(processedText);
                            
                            if(results.length > 0) {
                                const best = results[0];
                                acc = Math.round((1 - best.score) * 100);
                                
                                if (acc > 65) {
                                    reply = best.item.a;
                                } else if (acc > 40) {
                                    reply = `æˆ‘ä¸å¤ªç¢ºå®š...\nä½ æ˜¯æƒ³å•ã€Œ${best.item.q}ã€å—ï¼Ÿ\n\n${best.item.a}`;
                                } else {
                                    reply = this.fallbackReplies[Math.floor(Math.random() * this.fallbackReplies.length)];
                                }
                            } else {
                                reply = this.fallbackReplies[Math.floor(Math.random() * this.fallbackReplies.length)];
                            }
                        }

                        this.isTyping = false;
                        this.chatHistory.push({id: Date.now()+1, text: reply, isUser: false, accuracy: acc > 0 ? acc : null});
                        this.playSound('success');
                        this.$nextTick(() => scrollContainer.scrollTop = scrollContainer.scrollHeight);
                    }, 800);
                },
                openMsgDetail(msg) { 
                    if(msg.accuracy) this.showModal('AI åˆ†æ', `å•é¡ŒåŒ¹é…ä¿¡å¿ƒåº¦ï¼š${msg.accuracy}%`, 'info'); 
                    this.playSound('click'); 
                },

                startQuiz() {
                    if(!this.quizTakerName) return this.showModal('æç¤º', 'è«‹å…ˆè¼¸å…¥åå­—ï¼', 'error');
                    let allQ = window.deerQuiz_DB || [];
                    let shuffled = [...allQ].sort(() => 0.5 - Math.random());
                    this.currentQuizSet = shuffled.slice(0, 5);
                    this.quizStarted = true;
                    this.quizScore = 0;
                    this.currentQuizIndex = 0;
                    this.playSound('success');
                    this.loadQuestion();
                },
                loadQuestion() { this.hasAnswered = false; this.selectedOption = null; this.currentQuestion = this.currentQuizSet[this.currentQuizIndex]; this.currentOptions = [...this.currentQuestion.options].sort(() => 0.5 - Math.random()); },
                checkAnswer(opt) {
                    if(this.hasAnswered) return;
                    this.hasAnswered = true;
                    this.selectedOption = opt;
                    if(opt === this.currentQuestion.a) { this.quizScore++; confetti({ origin: { y: 0.8 }, particleCount: 50 }); this.playSound('success'); } else { this.playSound('click'); }
                },
                nextQuestion() {
                    this.playSound('click');
                    if(this.currentQuizIndex < this.currentQuizSet.length - 1) {
                        this.currentQuizIndex++;
                        this.loadQuestion();
                    } else {
                        this.quizStarted = false;
                        this.isProcessing = true;
                        setTimeout(async () => {
                            await this.captureElement('examPaperTemplate', 'certificate');
                            this.isProcessing = false;
                        }, 500);
                    }
                },

                async generateIDCard() {
                    if(!this.idCardName) return this.showModal('æç¤º', 'è«‹è¼¸å…¥æš±ç¨±', 'error');
                    this.isProcessing = true;
                    this.playSound('click');
                    setTimeout(async () => { await this.captureElement('idCardTemplate', 'share'); this.isProcessing = false; }, 100);
                },

                async openShareModal(item) {
                    document.getElementById('scQ').innerText = item.q;
                    document.getElementById('scA').innerText = item.a;
                    this.isProcessing = true;
                    this.playSound('click');
                    setTimeout(async () => { await this.captureElement('shareCardTemplate', 'share'); this.isProcessing = false; }, 100);
                },

                async captureElement(id, type) {
                    const el = document.getElementById(id);
                    try {
                        const canvas = await html2canvas(el, { 
                            scale: 2, 
                            useCORS: true, 
                            allowTaint: true,
                            backgroundColor: null,
                            logging: false
                        });
                        const img = canvas.toDataURL("image/png");
                        this.modal.type = type;
                        const title = type === 'certificate' ? 'æ­å–œç²å¾—æˆç¸¾è­‰æ˜' : 'ç”ŸæˆæˆåŠŸ';
                        this.showModal(title, 'é•·æŒ‰ä¸‹æ–¹åœ–ç‰‡å³å¯å„²å­˜', type);
                        this.$nextTick(() => { document.getElementById('shareResult').innerHTML = `<img src="${img}" class="w-full h-auto rounded-xl">`; });
                        this.playSound('success');
                    } catch(e) { 
                        this.showModal('éŒ¯èª¤', 'åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error'); 
                    }
                }
            }
        }
    </script>
</body>
</html>